<html>
	<head>
		<title>A Simulator for Conway's Game of Life - K.L. Studio</title>
		<style type="text/css">
			body
			{
				font-family: sans-serif, Arial;
			}

			.wrapper
			{
				text-align: center;
			}

			button.active
			{
				font-weight: bold;
			}

			#world-width, #world-height
			{
				width: 3em;
			}

			#start
			{
				font-size: large;
			}

			#viewer
			{
				padding: 12px 0;
				margin: 20px 0;
				background-color: #f4f4f4;
			}

			#canvas
			{
				border: 1px dashed #ccc;
				cursor: crosshair;
				background-color: white;
				-webkit-transition: all ease 0.3s;
				-moz-transition: all ease 0.3s;
			}
			#canvas.active
			{
				border: 1px solid #fc0;
				box-shadow: 0px 0px 3px #fc0;
				cursor: not-allowed;
			}

			#status-bar
			{
				font-size: small;
			}

			.status-value
			{
				display: inline-block;
				text-align: left;
				font-weight: bold;
			}

			#cursor-x, #cursor-y
			{
				width: 3em;
			}

			#archive
			{
				width: 40em;
				height: 6em;
			}

			#footer
			{
				margin-top: 60px;
				font-size: small;
				color: #666;
			}
		</style>
		<script src="jquery.js" type="text/javascript"></script>
		<script type="text/javascript">
			var World = function(options){
				if(options.data)
					this.loadData(options.data);
				else{
					this.reset(options.width, options.height);
					this.Wrap = options.wrap;
				}
				this.Callbacks = options.callbacks || {};
				this.RunInterval = options.interval || 10;
			};

			World.prototype.reset = function(width, height) {
				if (width != undefined)
					this.Width = Number(width);
				if (height != undefined)
					this.Height = Number(height);

				this.Cells = [];
				for (var i = 0; i < this.Height; ++i)
					this.Cells.push(new Array());

				this.copyCells();

				this.Time = 0;
				this.IsRunning = false;
			};

			World.prototype.copyCells = function() {
				this.LastCells = [];
				for (var i in this.Cells)
					this.LastCells[i] = this.Cells[i].slice(0);
			};

			World.prototype.get = function(x, y, cells) {
				cells = cells || this.Cells;

				if (x < 0 || x >= this.Width || y < 0 || y >= this.Height) {
					if (!this.Wrap)
						return false;
					else {
						x %= this.Width;
						if (x < 0)
							x += this.Width;
						y %= this.Height;
						if (y < 0)
							y += this.Height;
					}
				}

				return cells[y][x] ? true : false;
			};

			World.prototype.step = function() {
				this.copyCells();

				for (var y = 0; y < this.Height; ++y)
					for (var x = 0; x < this.Width; ++x) {
					var value = this.evaluate(x, y);
					if (value != this.Cells[y][x]) {
						this.Cells[y][x] = value;

						if (this.Callbacks.onCellChange)
							this.Callbacks.onCellChange(x, y, value);
					}
				}

				++this.Time;

				if (this.Callbacks.onStep)
					this.Callbacks.onStep(world);
			};

			World.prototype.run = function() {
				var self = this;

				this.RunHandler = setInterval(function() {
					self.step();
				}, this.RunInterval);

				this.IsRunning = true;
			};

			World.prototype.stop = function() {
				if (this.RunHandler)
					clearInterval(this.RunHandler);

				this.IsRunning = false;
			};

			World.prototype.neighbors = [[-1, -1], [0, -1], [1, -1], [-1, 0], [1, 0], [-1, 1], [0, 1], [1, 1]];

			World.prototype.aliveNeighbors = function(x, y) {
				var alives = 0;
				for (var i in this.neighbors)
					if (this.get(x + this.neighbors[i][0], y + this.neighbors[i][1], this.LastCells))
						++alives;

				return alives;
			};

			World.prototype.evaluate = function(x, y) {
				var alives = this.aliveNeighbors(x, y);

				return this.Cells[y][x] ? (alives >= 2 && alives <= 3) : alives == 3;
			};

			World.prototype.saveCells = function(cells, width, height){
				var data = "";

				for(var i = 0; i < width * height / 6; ++i){
					var code = 0;
					for(var b = 0; b < 6; ++b){
						var index = i * 6 + b;
						var x = index % width;
						var y = Math.floor(index / width);
						if(cells[y] && cells[y][x])
							code |= 1 << b;
					}

					data += String.fromCharCode(code + 0x30);
				}

				// remove "0"s at tail.
				data = data.replace(/(0+)$/, "")

				return data;
			};

			World.prototype.loadCells = function(data, width, height) {
				var cells = new Array();
				for (var y = 0; y < height; ++y)
					cells.push(new Array());

				for (var i in data) {
					var code = data.charCodeAt(i) - 0x30;

					for (var b = 0; b < 6; ++b) {
						var index = i * 6 + b;
						var x = index % width;
						var y = Math.floor(index / width);
						if (code & (1 << b))
							cells[y][x] = true;
					}
				}

				return cells;
			};

			World.prototype.saveData = function() {
				return this.Width + "," + this.Height + "," + ($("#world-wrap")[0].checked ? 1 : 0) + "," + World.prototype.saveCells(this.Cells, world.Width, world.Height);
			};

			World.prototype.loadData = function(data) {
				var fields = data.match(/(\d+),(\d+),(\d),(.*)/);

				this.Width = Number(fields[1]);
				this.Height = Number(fields[2]);
				this.Wrap = fields[3] != 0;
				this.Cells = World.prototype.loadCells(fields[4], this.Width, this.Height);
				this.copyCells();
				this.Time = 0;
			};


			var world = null;
			var leftButtonDown = false;
			var cc = null;
			var lastMousePosition = null;
			var zoom = 4, canvasZoom = 4;

			$(function() {
				$("#world-width").bind("textchange", onWorldConfigChange);
				$("#world-height").bind("textchange", onWorldConfigChange);
				$("#world-wrap").click(onWorldConfigChange);

				$("#reset").click(onReset);
				$("#start").click(start);
				$("#step").click(step);
				$("#randomize").click(randomize);
				$("#zoom").change(onZoomChange);

				$("#canvas").mousemove(onMouseMove);
				$("#canvas").mousedown(onMouseDown);
				$("#canvas").mouseup(onMouseUp);
				$("#canvas")[0].onselectstart = function() { return false; };
				$("#canvas").mouseleave(function() { $("#cursor-x").text(""); $("#cursor-y").text(""); });

				cc = $("#canvas")[0].getContext("2d");

				$(document).keydown(onKeyDown);

				$("#save-archive").click(saveArchive);
				$("#load-archive").click(loadArchive);

				if (location.hash)
					$("#archive").val(location.hash);

				reset(location.hash ? location.hash : null);
			});

			var mousePosition = function(event) {
				var offset = $("#canvas").offset();
				return { x: Math.floor((event.pageX - offset.left - 1) / zoom), y: Math.floor((event.pageY - offset.top - 1) / zoom) };
			};

			var onReset = function() {
				reset();

				$("#reset").text("Reset");
			};

			var reset = function(data) {
				if (world)
					stop();

				if(data)
					world = new World({ data: data, callbacks: { onCellChange: paintPoint, onStep: onStep} });
				else
					world = new World({ width: $("#world-width").val(), height: $("#world-height").val(), wrap: $("#world-wrap")[0].checked, callbacks: { onCellChange: paintPoint, onStep: onStep} });

				refreshCanvas();
			};

			var onMouseMove = function(event) {
				var pos = mousePosition(event);
				$("#cursor-x").text(pos.x);
				$("#cursor-y").text(pos.y);

				if (!world.IsRunning && leftButtonDown) {
					if (!lastMousePosition || lastMousePosition.x != pos.x || lastMousePosition.y != pos.y)
						writePoint(pos.x, pos.y);

					lastMousePosition = pos;
				}
			};

			var onMouseDown = function(event) {
				if (event.button == 0) {
					leftButtonDown = true;

					var pos = mousePosition(event);
					writePoint(pos.x, pos.y);
				}
			};

			var onMouseUp = function(event) {
				if (event.button == 0) {
					leftButtonDown = false;
					lastMousePosition = null;
				}
			};

			var onKeyDown = function(event) {
				switch (event.keyCode) {
					case 32:
						step();

						break;
				}
			};

			var step = function() {
				stop();
				world.step();
			};

			var onStep = function() {
				$("#time").text(world.Time);
			};

			var writePoint = function(x, y, value) {
				if (x >= 0 && x < world.Width && y >= 0 && y < world.Height) {
					if (value == undefined)
						value = !world.Cells[y][x];
					world.Cells[y][x] = value;

					paintPoint(x, y, value);
				}
			};

			var paintPoint = function(x, y, value) {
				if (value)
					cc.fillRect(x * canvasZoom, y * canvasZoom, canvasZoom, canvasZoom);
				else
					cc.clearRect(x * canvasZoom, y * canvasZoom, canvasZoom, canvasZoom);
			};

			var randomize = function() {
				world.reset();

				for (var y = 0; y < world.Height; ++y)
					for (var x = 0; x < world.Width; ++x) {
					writePoint(x, y, Math.random() < 0.5);
				}
			};

			var start = function() {
				if (!world.IsRunning) {
					$("#world-config input").attr("disabled", true);
					$("#start").text("Stop");
					$("#start").addClass("active");
					$("#randomize").attr("disabled", true);
					$("#load-archive").attr("disabled", true);
					$("#canvas").addClass("active");

					world.run();
				}
				else
					stop();
			};

			var stop = function() {
				$("#world-config input").attr("disabled", false);
				$("#start").text("Run");
				$("#start").removeClass("active");
				$("#randomize").attr("disabled", false);
				$("#load-archive").attr("disabled", false);
				$("#canvas").removeClass("active");

				world.stop();
			};

			var onZoomChange = function(){
				zoom = Number($("#zoom").val());
				canvasZoom = zoom < 1 ? 1 : zoom;

				refreshCanvas();
			};

			var refreshCanvas = function(){
				$("#world-width").val(world.Width);
				$("#world-height").val(world.Height);
				$("#world-wrap").attr("checked", world.Wrap);

				$("#canvas").width(world.Width * zoom);
				$("#canvas").height(world.Height * zoom);
				$("#canvas").attr("width", world.Width * canvasZoom);
				$("#canvas").attr("height", world.Height * canvasZoom);

				$("#time").text(world.Time);

				//cc.clearRect(0, 0, world.Width * canvasZoom, world.Height * canvasZoom);

				for (var y = 0; y < world.Height; ++y)
					for (var x = 0; x < world.Width; ++x) {
						paintPoint(x, y, world.Cells[y][x]);
					}
			};

			var saveArchive = function(){
				var data = world.saveData();

				$("#archive").val(data);
				$("#archive").select();

				location.hash = data;
			};

			var loadArchive = function(){
				try{
					world.loadData($("#archive").val());
				}
				catch(e){
					alert("invalid data: " + e);
				}

				refreshCanvas();
			};

			var onWorldConfigChange = function() {
				$("#reset").text("Reset *");
			};
		</script>
		<script type="text/javascript">
			var _gaq = _gaq || [];
			_gaq.push(['_setAccount', 'UA-20678203-1']);
			_gaq.push(['_trackPageview']);

			(function () {
				var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
				ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
				var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			})();
		</script>
	</head>
	<body>
		<div class="wrapper">
			<p>
				<span id="world-config">
					W:<input type="text" id="world-width" value="128" />
					H:<input type="text" id="world-height" value="128"" />
					Wrap:<input type="checkbox" id="world-wrap" checked="checked" />
				</span>
				Zoom: <select id="zoom">
					<option value="0.25">1/4</option>
					<option value="0.5">1/2</option>
					<option value="1">1</option>
					<option value="2">2</option>
					<option value="4" selected="selected">4</option>
					<option value="8">8</option>
				</select>
				<button id="reset">Reset</button>
				<button id="start">Run</button>
				<button id="step">Step</button>
				<button id="randomize">Randomize</button>
			</p>
			<div id="viewer">
				<canvas id="canvas"></canvas>
				<p id="status-bar">
					x: <span id="cursor-x" class="status-value"></span>y: <span id="cursor-y" class="status-value"></span>t: <span id="time" class="status-value"></span>
				</p>
			</div>
			<div id="data">
				<textarea id="archive"></textarea>
				<p>
					<button id="save-archive">Save</button>
					<button id="load-archive">Load</button>
				</p>
			</div>
			<div id="footer">
				<span>by <a href="https://plus.google.com/107810202308609674959" target="_blank" title="K.L.'s profile on Google">K.L.</a> - 2011</span>
			</div>
		</div>
	</body>
</html>
