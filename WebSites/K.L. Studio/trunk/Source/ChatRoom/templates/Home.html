<html>
	<head>
		<title>Chat Room</title>
		<link href="static/ChatRoom.css" rel="stylesheet" type="text/css" />
		<script src="/js/jquery.js" type="text/javascript"></script>
		<script type="text/javascript">
			$(document).ready(function(){
				updateLayout();

				var selfroom = new Room({title: "My Room", src: "host-dialog", no_close: true});
				var guestrooms = {};

				var roomitemclick = function(session){
					guestrooms[session.id] = guestrooms[session.id] || new Room({title: session.host.nickname + "'s Room", src: "guest-dialog?id=" + session.id, callbacks:{
						close: function(){
							guestrooms[session.id].close();
							delete guestrooms[session.id];
						}
					}});
				}

				// set parameters for #online-frame
				$("#online-frame").get(0).contentWindow.callbacks = {
					"ItemClick": roomitemclick
				};

				// set parameters for #contacts-frame
				$("#contacts-frame").get(0).contentWindow.callbacks = {
					"ItemClick": roomitemclick
				};

				$(window).focus(function() {
					$.each($(".dialog-form-body-frame"), function(i, frame){
						frame.contentWindow.chatroom.activateAllSessions();
					});
				});
				$(window).blur(function() {
					$.each($(".dialog-form-body-frame"), function(i, frame){
						frame.contentWindow.chatroom.deactivateAllSessions();
					});
				});
			});

			var Room = function(options)
			{
				options.callbacks = options.callbacks || {};

				var dialogs_frame = $("#dialogs_frame");
				dialogs_frame.append("<div class='dialog-form-wrapper'></div>");
				var wrapper = dialogs_frame.find(".dialog-form-wrapper:last");
				wrapper.load("static/dialog-form", function(){
					var dialog_form = dialogs_frame.find(".dialog-form:last");
					dialog_form.find(".dialog-form-title-text").text(options.title);

					dialog_form.find(".dialog-form-body-frame").attr("src", options.src);

					if(options.no_close)
						dialog_form.find(".icon-close").hide();

					if(options.callbacks.close)
						dialog_form.find(".icon-close").click(options.callbacks.close);

					dialog_form.find(".dialog-form-title").click(function(){
						var body = dialog_form.find(".dialog-form-body");
						if(body.height() >= 240)
							body.height(0);
						else
							body.height(240);
					});
				});

				this.close = function(){
					wrapper.remove();
				};
			};

			var updateLayout = function()
			{
				$("#canvas").height($(window).height() - $("#header").outerHeight(true) - $("#logo").outerHeight() - 3);
				$("#online").css("max-height", $("#canvas").innerHeight() - 1);
				$("#contacts").css("max-height", $("#canvas").innerHeight() - $("#online").height() - 1);
			};

			$(window).resize(updateLayout);
		</script>
		<script type="text/javascript">

		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-20678203-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();

		</script>
	</head>
	<body>
		<div id="header">
			<div style="margin: 2px 8px;">
				<div id="account-bar">
					<b>{{current_user.email}}</b> |
					<a href="{{logout_url}}">logout</a>
				</div>
				<div style="clear:both;"></div>
			</div>
		</div>
		<div id="logo">
			<a href="/">
				<img src="/res/images/K.L._Stuidio_Logo_small.png" />
			</a>
		</div>
		<div id="main">
			<div id="nav">
				<div id="online" class="nav-section">
					<iframe id="online-frame" src="room-list" frameBorder="0"></iframe>
				</div>
				<div id="contacts" class="nav-section">
					<iframe id="contacts-frame" src="contacts-list" frameBorder="0"></iframe>
				</div>
			</div>
			<div id="canvas">
			</div>
		</div>
		<div class="layer-container">
			<div id="dialogs_frame">
			</div>
		</div>
	</body>
</html>
