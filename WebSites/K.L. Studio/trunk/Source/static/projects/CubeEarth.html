<html>
	<head>
		<title>Cube Earth</title>
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
		<script src="../js/jquery.js" type="text/javascript"></script>
		<script src="../js/copperlicht.js" type="text/javascript"></script>
		<style type="text/css">
			body
			{
				margin: 0;
				background: -webkit-gradient(linear, left top, left bottom, from(#fff), to(#aaa));
			}

			#cube-earth
			{
				position: absolute;
				left: 10%;
				top: 10%;
				width: 80%;
				height: 80%;
			}
		</style>
		<script id="vs-simplecolor" type="x-shader/x-vertex">
			#ifdef GL_ES
			precision highp float;
			#endif

			uniform mat4	worldviewproj;
			attribute vec4	vPosition;

			void main()
			{
				gl_Position = worldviewproj * vPosition;
			}
		</script>
		<script id="fs-simplecolor" type="x-shader/x-fragment">
			#ifdef GL_ES
			precision highp float;
			#endif

			uniform vec4 vColor;

			void main()
			{
				gl_FragColor = vColor;
			}
		</script>
		<script type="text/javascript">
			CL3D.MeshBuffer.prototype.setVIMesh = function(mesh) {
				if (this.Vertices != mesh.vertices || this.Indices != mesh.indicies) {
					this.Vertices = mesh.vertices;
					this.Indices = mesh.indicies;
					this.update();
				}
			};

			CL3D.Renderer.prototype.MaterialUniforms = {};

			CL3D.Renderer.prototype.createMaterialTypeEx = function(vs, fs, uniforms, blendenabled, blendsfactor, blenddfactor) {
				var type = this.createMaterialType(vs, fs, blendenabled, blendsfactor, blenddfactor);

				this.MaterialUniforms[type] = uniforms;

				return type;
			};

			CL3D.Renderer.prototype.OnChangeMaterial = function(mattype) {
				var uniforms = this.MaterialUniforms[mattype];
				if (uniforms) {
					var gl = this.getWebGL();
					var program = this.getGLProgramFromMaterialType(mattype);
					$.each(uniforms, function(key, uniform) {
						var location = gl.getUniformLocation(program, key);

						while (typeof (uniform) == "function")
							uniform = uniform();

						if (typeof (uniform) == "number")
							gl.uniform1f(location, uniform);
						else
							switch (uniform.length) {
							case 1:
								gl.uniform1f(location, uniform[0]);
								break;
							case 2:
								gl.uniform2f(location, uniform[0], uniform[1]);
								break;
							case 3:
								gl.uniform3f(location, uniform[0], uniform[1], uniform[2]);
								break;
							case 4:
								gl.uniform4f(location, uniform[0], uniform[1], uniform[2], uniform[3]);
								break;
							default:
								throw "invalid uniform length: " + uniform.length;
							}
					});
				}
			};
		</script>
		<script type="text/javascript">
			var CL, Scene;

			var util = {
				createVertex: function(pos, normal, tu, tv) {
					var v = new CL3D.Vertex3D(true);
					v.Pos = pos;
					if (normal)
						v.Normal = normal;
					if (tu || tu == 0)
						v.TCoords.X = tu;
					if (tv || tv == 0)
						v.TCoords.Y = tv;

					return v;
				},
				createSimpleCubeMesh: function(length) {
					length = length || 1;
					var half = length / 2;

					var vertices = [
						util.createVertex(new CL3D.Vect3d(-half, -half, -half)),
						util.createVertex(new CL3D.Vect3d(-half, -half, +half)),
						util.createVertex(new CL3D.Vect3d(-half, +half, -half)),
						util.createVertex(new CL3D.Vect3d(-half, +half, +half)),

						util.createVertex(new CL3D.Vect3d(+half, -half, -half)),
						util.createVertex(new CL3D.Vect3d(+half, -half, +half)),
						util.createVertex(new CL3D.Vect3d(+half, +half, -half)),
						util.createVertex(new CL3D.Vect3d(+half, +half, +half))
					];
					var indicies = [
						0, 1, 2, 1, 3, 2,
						4, 6, 5, 5, 6, 7,
						1, 5, 3, 5, 7, 3,
						0, 2, 4, 2, 6, 4,
						2, 3, 7, 7, 6, 2,
						5, 1, 0, 0, 4, 5
					];

					return { vertices: vertices, indicies: indicies };
				},
				createCubeArrayMeshes: function(options) {
					options = options || {};
					options.Segments = options.Segments || 10;

					var grids = options.Segments * 1.5 + 1;
					var inv_grids = 1 / grids;

					var eachRange2D = function(ul, uh, vl, vh, elem) {
						for (var u = ul; u <= uh; ++u)
							for (var v = vl; v <= vh; ++v)
							elem(u, v);
					};

					var indicies = [];
					var faceIndexCount = (options.Segments + 1) * (options.Segments + 1);
					for (var f = 0; f < 6; ++f) {
						eachRange2D(0, options.Segments - 1, 0, options.Segments - 1, function(u, v) {
							var base = faceIndexCount * f;

							indicies.push(base + u * (options.Segments + 1) + v);
							indicies.push(base + (u + 1) * (options.Segments + 1) + v);
							indicies.push(base + (u + 1) * (options.Segments + 1) + v + 1);

							indicies.push(base + u * (options.Segments + 1) + v);
							indicies.push(base + (u + 1) * (options.Segments + 1) + v + 1);
							indicies.push(base + u * (options.Segments + 1) + v + 1);
						});
					}
					//indicies = [0, 3, 4, 0, 4, 1];

					var units = [];

					// traverse all units
					for (var ax = -1; ax <= 1; ++ax)
						for (var ay = -1; ay <= 1; ++ay)
							for (var az = -1; az <= 1; ++az) {
								var vertices = [];

								var xl = ax * (options.Segments + 1) - options.Segments / 2, xh = ax * (options.Segments + 1) + options.Segments / 2;
								var yl = ay * (options.Segments + 1) - options.Segments / 2, yh = ay * (options.Segments + 1) + options.Segments / 2;
								var zl = az * (options.Segments + 1) - options.Segments / 2, zh = az * (options.Segments + 1) + options.Segments / 2;

								eachRange2D(yl, yh, zl, zh, function(y, z) { vertices.push(util.createVertex(new CL3D.Vect3d(xl, y, z).multiplyWithScal(inv_grids))); });
								eachRange2D(zl, zh, yl, yh, function(z, y) { vertices.push(util.createVertex(new CL3D.Vect3d(xh, y, z).multiplyWithScal(inv_grids))); });
								eachRange2D(zl, zh, xl, xh, function(z, x) { vertices.push(util.createVertex(new CL3D.Vect3d(x, yl, z).multiplyWithScal(inv_grids))); });
								eachRange2D(xl, xh, zl, zh, function(x, z) { vertices.push(util.createVertex(new CL3D.Vect3d(x, yh, z).multiplyWithScal(inv_grids))); });
								eachRange2D(xl, xh, yl, yh, function(x, y) { vertices.push(util.createVertex(new CL3D.Vect3d(x, y, zl).multiplyWithScal(inv_grids))); });
								eachRange2D(yl, yh, xl, xh, function(y, x) { vertices.push(util.createVertex(new CL3D.Vect3d(x, y, zh).multiplyWithScal(inv_grids))); });

								units.push({ vertices: vertices, indicies: indicies });
							}

					return units;
				}
			};
			util.SimpleCubeMesh = util.createSimpleCubeMesh(1);
			util.CubeArrayMeshes = util.createCubeArrayMeshes();

			$(function() {
				var canvas = $("#cube-earth");
				canvas.attr("width", canvas.width());
				canvas.attr("height", canvas.height());

				CL = new CL3D.CopperLicht("cube-earth", null, 30);
				if (CL.initRenderer({ antialias: true })) {
					Scene = new CL3D.Scene();
					CL.addScene(Scene);

					Scene.setBackgroundColor(0x00000000);

					var cam = new CL3D.CameraSceneNode();
					cam.Pos = new CL3D.Vect3d(0, 0, 1);
					cam.setTarget(new CL3D.Vect3d(0, 0, 0));
					cam.setFov(Math.PI * 0.4);
					var animator = new CL3D.AnimatorCameraModelViewer(cam, CL, [0]);
					cam.addAnimator(animator);
					animator.Radius = 3;
					Scene.getRootSceneNode().addChild(cam);
					Scene.setActiveCamera(cam);
					cam.setAspectRatio(canvas.width() / canvas.height());

					var cube = new CL3D.SceneNode();
					Scene.getRootSceneNode().addChild(cube);

					var cubeMat = CL.getRenderer().createMaterialTypeEx($("#vs-simplecolor").text(), $("#fs-simplecolor").text(), { vColor: [0, 0.2, 0.4, 1] });

					$.each(util.CubeArrayMeshes, function(i, unit) {
						var buffer = new CL3D.MeshBuffer();
						buffer.setVIMesh(unit);
						buffer.Mat.Type = cubeMat;

						var mesh = new CL3D.Mesh();
						mesh.AddMeshBuffer(buffer);

						var node = new CL3D.MeshSceneNode();
						node.setMesh(mesh);
						cube.addChild(node);
					});
				}
			});
		</script>
	</head>
	<body>
		<canvas id="cube-earth"></canvas>
	</body>
</html>
