<html>
	<head>
		<title>A Simulator for the Game of Life - K.L. Studio</title>
		<style type="text/css">
			.wrapper
			{
				text-align: center;
			}

			#canvas
			{
				border: 1px dashed #ccc;
				cursor: crosshair;
			}
			#canvas.active
			{
				border: 1px solid #fc0;
				box-shadow: 0px 0px 3px #fc0;
				cursor: not-allowed;
			}

			#status-bar
			{
				font-size: small;
			}

			.status-value
			{
				display: inline-block;
				text-align: left;
				font-weight: bold;
			}

			#cursor-x, #cursor-y
			{
				width: 3em;
			}
		</style>
		<script src="jquery.js" type="text/javascript"></script>
		<script type="text/javascript">
			var World = function(options){
				this.reset(options.width, options.height);
				this.Wrap = options.wrap;
				this.Callbacks = options.callbacks || {};
				this.RunInterval = options.interval || 10;
			};

			World.prototype.reset = function(width, height){
				if(width != undefined)
					this.Width = Number(width);
				if(height != undefined)
					this.Height = Number(height);

				this.Cells = [];
				for(var i = 0; i < this.Height; ++i)
					this.Cells.push(new Array());

				this.copyCells();

				this.Time = 0;
				this.IsRunning = false;
			};

			World.prototype.copyCells = function(){
				this.LastCells = [];
				for(var i in this.Cells)
					this.LastCells[i] = this.Cells[i].slice(0);
			};

			World.prototype.get = function(x, y, cells){
				cells = cells || this.Cells;

				if(x < 0 || x >= this.Width || y < 0 || y >= this.Height){
					if(!this.Wrap)
						return false;
					else{
						x %= this.Width;
						if(x < 0)
							x += this.Width;
						y %= this.Height;
						if(y < 0)
							y += this.Height;
					}
				}

				return cells[y][x] ? true : false;
			};

			World.prototype.step = function(){
				this.copyCells();

				for(var y = 0; y < this.Height; ++y)
					for(var x = 0; x < this.Width; ++x){
						var value = this.evaluate(x, y);
						if(value != this.Cells[y][x]) {
							this.Cells[y][x] = value;

							if(this.Callbacks.onCellChange)
								this.Callbacks.onCellChange(x, y, value);
						}
					}

				++this.Time;

				if(this.Callbacks.onStep)
					this.Callbacks.onStep(world);
			};

			World.prototype.run = function(){
				var self = this;

				this.RunHandler = setInterval(function(){
					self.step();
				}, this.RunInterval);

				this.IsRunning = true;
			};

			World.prototype.stop = function(){
				if(this.RunHandler)
					clearInterval(this.RunHandler);

				this.IsRunning = false;
			};

			World.prototype.neighbors = [[-1, -1], [0, -1], [1, -1], [-1, 0], [1, 0], [-1, 1], [0, 1], [1, 1]];

			World.prototype.aliveNeighbors = function(x, y){
				var alives = 0;
				for(var i in this.neighbors)
					if(this.get(x + this.neighbors[i][0], y + this.neighbors[i][1], this.LastCells))
						++alives;

				return alives;
			};

			World.prototype.evaluate = function(x, y){
				var alives = this.aliveNeighbors(x, y);

				if(this.Cells[y][x])
					return alives >= 2 && alives <= 3;
				else
					return alives == 3;
			};


			var world = null;
			var leftButtonDown = false;
			var cc = null;

			$(function(){
				$("#reset").click(reset);
				$("#start").click(start);
				$("#step").click(step);
				$("#randomize").click(randomize);

				$("#canvas").mousemove(onMouseMove);
				$("#canvas").mousedown(onMouseDown);
				$("#canvas").mouseup(onMouseUp);
				$("#canvas")[0].onselectstart = function(){return false;};
				$("#canvas").mouseleave(function(){ $("#cursor-x").text(""); $("#cursor-y").text(""); });

				cc = $("#canvas")[0].getContext("2d");

				$(document).keydown(onKeyDown);

				reset();
			});

			var mousePosition = function(event){
				var offset = $("#canvas").offset();
				return {x: event.pageX - offset.left - 1, y: event.pageY - offset.top - 1};
			};

			var reset = function(){
				if(world)
					stop();

				world = new World({width: $("#world-width").val(), height: $("#world-height").val(), wrap: $("#world-wrap").attr("checked"), callbacks: {onCellChange: paintPoint, onStep: onStep}});

				$("#canvas").width(world.Width);
				$("#canvas").height(world.Height);
				$("#canvas").attr("width", world.Width);
				$("#canvas").attr("height", world.Height);

				$("#time").text(world.Time);
			};

			var onMouseMove = function(event){
				var pos = mousePosition(event);
				$("#cursor-x").text(pos.x);
				$("#cursor-y").text(pos.y);

				if(leftButtonDown)
					writePoint(pos.x, pos.y);
			};

			var onMouseDown = function(event){
				if(event.button == 0) {
					leftButtonDown = true;

					var pos = mousePosition(event);
					writePoint(pos.x, pos.y);
				}
			};

			var onMouseUp = function(event){
				if(event.button == 0)
					leftButtonDown = false;
			};

			var onKeyDown = function(event){
				switch(event.keyCode){
					case 32:
						step();

						break;
				}
			};

			var step = function(){
				stop();
				world.step();
			};

			var onStep = function(){
				$("#time").text(world.Time);
			};

			var writePoint = function(x, y, value){
				if(x >= 0 && x < world.Width && y >= 0 && y < world.Height) {
					if(value == undefined)
						value = !world.Cells[y][x];
					world.Cells[y][x] = value;

					paintPoint(x, y, value);
				}
			};

			var paintPoint = function(x, y, value){
				if(value)
					cc.fillRect(x, y, 1, 1);
				else
					cc.clearRect(x, y, 1, 1);
			};

			var randomize = function(){
				world.reset();

				for(var y = 0; y < world.Height; ++y)
					for(var x = 0; x < world.Width; ++x){
						writePoint(x, y, Math.random() < 0.5);
					}
			};

			var start = function(){
				if(!world.IsRunning){
					$("#world-config input").attr("disabled", true);
					$("#start").text("Stop");
					$("#randomize").attr("disabled", true);
					$("#canvas").addClass("active");

					world.run();
				}
				else
					stop();
			};

			var stop = function(){
				$("#world-config input").attr("disabled", false);
				$("#start").text("Start");
				$("#randomize").attr("disabled", false);
				$("#canvas").removeClass("active");

				world.stop();
			};
		</script>
	</head>
	<body>
		<div class="wrapper">
			<p>
				<span id="world-config">
					W:<input type="text" id="world-width" value="128" size="3" />
					H:<input type="text" id="world-height" value="128" size="3" />
					wrap:<input type="checkbox" id="world-wrap" checked="checked" />
				</span>
				<button id="reset">Reset</button>
				<button id="start">Start</button>
				<button id="step">Step</button>
				<button id="randomize">Randomize</button>
			</p>
			<canvas id="canvas"></canvas>
			<p id="status-bar">
				x: <span id="cursor-x" class="status-value"></span> y: <span id="cursor-y" class="status-value"></span> t: <span id="time" class="status-value"></span>
			</p>
		</div>
	</body>
</html>
