<!DOCTYPE html>
<html>
	<head>
		<title>MIDI Comparer</title>
		<style type="text/css">
			.midi-file.drag-hover
			{
				border: 2px solid red;
			}

			.midi-file.loading
			{
				color: #ccc;
				background-color: #ff8;
			}

			#controls
			{
				margin: 1em 0;
			}
		</style>
		<script src="../js/jquery.js" type="text/javascript"></script>
		<script src="../js/MIDI/AudioDetect.js" type="text/javascript"></script>
		<script src="../js/MIDI/LoadPlugin.js" type="text/javascript"></script>
		<script src="../js/MIDI/Plugin.js" type="text/javascript"></script>
		<script src="../js/MIDI/Player.js" type="text/javascript"></script>
		<script src="../js/MIDI/Window/DOMLoader.XMLHttp.js" type="text/javascript"></script>
		<script src="../js/MIDI/Window/DOMLoader.script.js" type="text/javascript"></script>
		<script src="../js/MIDI/inc/WebMIDIAPI.js" type="text/javascript"></script>
		<script src="../js/MIDI/inc/Base64.js" type="text/javascript"></script>
		<script src="../js/MIDI/inc/base64binary.js" type="text/javascript"></script>
		<script src="../js/MIDI/inc/replayer.js" type="text/javascript"></script>
		<script src="../js/MIDI/inc/midifile.js" type="text/javascript"></script>
		<script src="../js/MIDI/inc/stream.js" type="text/javascript"></script>
		<script type="text/javascript">
			var MidiData = {}

			var loadMidiFile = function (data, name, filename, onload) {
				MIDI.Player.loadFile(data, function () {
					MidiData[name] = MIDI.Player.data;

					if (onload)
						onload();
				});

				localStorage[name + "_data"] = data;
				localStorage[name + "_filename"] = filename;
			}

			var pickMidiFile = function (file, elem) {
				if (file && file.type == "audio/mid") {
					var fr = new FileReader();
					fr.onloadend = function (e) {
						elem.text(file.name);
						elem.addClass("loading");

						loadMidiFile(e.currentTarget.result, elem.data("name"), file.name, function () {
							elem.removeClass("loading");

							console.log(name + " MIDI file loaded:", file.name);
						});
					};
					fr.readAsDataURL(file);
				}
			};

			$(function () {
				$(".midi-file").each(function (i, elem) {
					elem.ondragover = function (e) {
						$(elem).addClass("drag-hover");
						e.preventDefault();
					};
					elem.ondragleave = function () {
						$(elem).removeClass("drag-hover");
					};

					elem.ondrop = function (e) {
						$(elem).removeClass("drag-hover");

						pickMidiFile(e.dataTransfer.files[0], $(elem));

						e.preventDefault();
						return false;
					};
				});

				$("#compare").click(function () {
					if (!MidiData.criterion) {
						console.error("criterion data is null.");
						return;
					}

					if (!MidiData.sample) {
						console.error("sample data is null.");
						return;
					}

					$("#compare").attr("disabled", true);
				});

				if (localStorage.criterion_data) {
					loadMidiFile(localStorage.criterion_data, "criterion", localStorage.criterion_filename);
					$("#file1").text(localStorage.criterion_filename);
				}

				if (localStorage.sample_data) {
					loadMidiFile(localStorage.sample_data, "sample", localStorage.sample_filename);
					$("#file2").text(localStorage.sample_filename);
				}
			});
		</script>
	</head>
	<body>
		<div id="input">
			<button id="file1" class="midi-file" data-name="criterion">...</button>
			<button id="file2" class="midi-file" data-name="sample">...</button>
		</div>
		<div id="controls">
			<button id="compare">COMPARE</button>
		</div>
		<div id="results">

		</div>
	</body>
</html>
