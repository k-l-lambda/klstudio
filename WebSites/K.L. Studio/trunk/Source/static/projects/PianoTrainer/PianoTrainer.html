<html>
	<head>
		<title>Piano Trainer</title>
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<style type="text/css">
			html
			{
				font-family: Verdana, Arial, Helvetica, sans-serif;
			}

			body
			{
				color: #ccc;
				background: #333;
				margin: 0;
				overflow: hidden;
				position: relative;
				height: 100%;
			}

			body.drag-hover
			{
				background: #3d5b3d;
			}

			#header
			{
				background: -webkit-gradient(linear,left top,left bottom,from(#444),to(#111));
				padding: 1px 0;
				box-shadow: 0 2px 4px rgba(0,0,0,.4);
			}

			#header p
			{
				text-align: center;
				margin: 1em 0;
			}

			#header .wrapper > *
			{
				vertical-align: middle;
			}

			#loading
			{
				position: absolute;
				top: 0;
				width: 100%;
				height: 100%;
				background: no-repeat no-repeat url(/res/images/loading-5d.gif) center;
				background-color: rgba(255, 255, 255, 0.2);
			}

			.wrapper
			{
				width: 1000px;
				margin: 0 auto;
			}

			#playback
			{
				display: inline-block;
			}

			#playback span
			{
				display: inline-block;
			}

			#playback > span, #playback-time > span, #input-device-bar > *
			{
				vertical-align: middle;
			}

			.image-button
			{
				transition-property: opacity;
				transition-duration: .2s;
				opacity: 0.7;
			}

			.image-button:hover
			{
				opacity: 1;
			}

			.image-button:active
			{
				opacity: 0.85;
			}

			#playback-time
			{
				margin-left: 20px;
			}

			#playback-progress
			{
				width: 240px;
				height: 32px;
				border: 1px solid #000;
				border-radius: 5px;
				box-shadow: 0 0 16px rgba(255, 255, 255, 0.4);
				overflow: hidden;
				background-image: -webkit-gradient(linear,left top,left bottom,color-stop(0,#444),color-stop(1,rgba(0,0,0,.7)));
				cursor: pointer;
				text-align: left;
			}

			#playback-progress-cursor
			{
				display: inline-block;
				position: relative;
				background: #888;
				background-image: -webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(0,0,0,0)),color-stop(1,rgba(0,0,0,.5)));
				transition-property: background;
				transition-duration: .3s;
				transition-timing-function: linear;
				height: 100%;
			}

			#playback-progress:hover #playback-progress-cursor
			{
				background-color: #0088e9;
			}

			#playback-time-text
			{
				margin-left: 1em;
			}

			#playback-source
			{
				margin-left: 20px;
				font-size: 20px;
				line-height: 24px;
				width: 16em;
				height: 24px;
				border-radius: 5px;
				white-space: nowrap;
				overflow: hidden;
				cursor: pointer;
				text-align: center;
				border: solid 1px transparent;
			}

			#playback-source:hover
			{
				overflow: visible;
			}

			.drag-hover #playback-source
			{
				border-color: #fc0;
			}

			#midi-pugin
			{
				visibility: hidden;
				position: absolute;
				z-index: -1000;
			}

			#input-device-bar
			{
				display: none;
			}

			#input-device
			{
				margin-left: 2em;
				width: 12em;
				color: inherit;
				background: inherit;
				font-family: inherit;
				border-color: #666;
			}

			#input-device-refresh
			{
				width: 20px;
				height: auto;
			}

			#range-controls
			{
				margin: 22px 0 8px !important;
			}

			#range-bar
			{
				opacity: 0.6;
				transition-property: opacity, background;
				transition-duration: .2s;
				position: relative;
				display: inline-block;
				width: 900px;
			}

			#range-bar:hover
			{
				opacity: 1;
			}

			#range-bar .mask
			{
				position: absolute;
				display: inline-block;
				top: 0;
				height: 100%;
				cursor: pointer;
			}

			#range-bar .mask:hover
			{
				border-color: #af4;
			}

			#range-bar .mask.hold
			{
				border-color: #f00;
			}

			#range-mask-left, #range-mask-right
			{
				background-color: rgba(0, 0, 0, 0.7);
				background: -webkit-gradient(linear,right top,right bottom,color-stop(0,rgba(0,0,0,0.8)),color-stop(0.5,rgba(0,0,0,0.3)),color-stop(1,rgba(0,0,0,0.8)));
			}

			#range-mask-left
			{
				border-right: 2px solid transparent;
				border-top-left-radius: 12px;
				border-bottom-left-radius: 12px;
			}

			#range-mask-right
			{
				border-left: 2px solid transparent;
				border-top-right-radius: 12px;
				border-bottom-right-radius: 12px;
			}

			#range-mask-middle
			{
				border-left: 2px solid transparent;
				border-right: 2px solid transparent;
			}

			#range-mask-left:hover
			{
				background: -webkit-gradient(linear,left top,right top,color-stop(0,rgba(80,80,80,1)),color-stop(0.8,rgba(80,120,80,0.9)),color-stop(1,rgba(0,120,0,0.4)));
			}

			#range-mask-right:hover
			{
				background: -webkit-gradient(linear,right top,left top,color-stop(0,rgba(80,80,80,1)),color-stop(0.8,rgba(80,120,80,0.9)),color-stop(1,rgba(0,120,0,0.4)));
			}

			#range-mask-left
			{
				left: 0;
			}

			#range-mask-right
			{
				right: 0;
			}

			#range-mask-middle
			{
				background-color: transparent;
				background: -webkit-gradient(linear,right top,right bottom,color-stop(0,rgba(0,0,0,0.3)),color-stop(0.5,rgba(0,0,0,0)),color-stop(1,rgba(0,0,0,0.3)));
			}

			#range-mask-middle:hover
			{
				background: -webkit-gradient(linear,left top,right top,color-stop(0,rgba(0,128,0,0.3)),color-stop(0.5,rgba(0,128,0,0)),color-stop(1,rgba(0,128,0,0.3)));
			}

			#range-canvas
			{
				height: 38px;
			}

			#range-keyboard .white-key
			{
				fill: white;
				stroke: #333;
				stroke-width: 1px;
			}

			#range-keyboard .black-key
			{
				fill: black;
			}

			#range-keyboard .white-key:hover, #range-keyboard .white-key.active
			{
				fill: #aaf;
			}

			#range-keyboard .black-key:hover, #range-keyboard .black-key.active
			{
				fill: #22d;
			}

			#range-keyboard-labels text
			{
				text-anchor: middle;
				font-size: 7px;
			}

			#keyboard-canvas, #score-canvas
			{
				position: relative;
			}

			#keyboard .key
			{
				cursor: pointer;
			}

			/* key of Middle C */
			#keyboard .key[data-note="60"]
			{
				fill: #fff0f0;
				stroke: black;
				stroke-width: 2;
			}
			#range-keyboard .key[data-note="60"]
			{
				fill: #fff0f0;
				stroke: black;
			}

			#keyboard .white-key
			{
				fill: white;
				stroke: #333;
				stroke-width: 1px;
			}

			#keyboard .black-key
			{
				fill: black;
			}

			#keyboard .white-key:hover
			{
				fill: #eef;
			}

			#keyboard .white-key.active
			{
				fill: #aaf;
			}

			#keyboard .black-key:hover
			{
				fill: #335;
			}

			#keyboard .black-key.active
			{
				fill: #22d !important;
			}

			#keyboard-labels text
			{
				text-anchor: middle;
				font-size: 12px;
				fill: #bbb;
			}

			#score-canvas
			{
				height: 100000px;
				background-color: black;
			}
		</style>
		<script src="../../js/jquery.js" type="text/javascript"></script>
		<script src="../../js/jquery.svg.js" type="text/javascript"></script>
		<script src="../../js/MIDI/AudioDetect.js" type="text/javascript"></script>
		<script src="../../js/MIDI/LoadPlugin.js" type="text/javascript"></script>
		<script src="../../js/MIDI/Plugin.js" type="text/javascript"></script>
		<script src="../../js/MIDI/Player.js" type="text/javascript"></script>
		<script src="../../js/MIDI/Window/DOMLoader.XMLHttp.js" type="text/javascript"></script>
		<script src="../../js/MIDI/Window/DOMLoader.script.js" type="text/javascript"></script>
		<script src="../../js/MIDI/inc/WebMIDIAPI.js" type="text/javascript"></script>
		<script src="../../js/MIDI/inc/Base64.js" type="text/javascript"></script>
		<script src="../../js/MIDI/inc/base64binary.js" type="text/javascript"></script>
		<script src="../../js/MIDI/inc/replayer.js" type="text/javascript"></script>
		<script src="../../js/MIDI/inc/midifile.js" type="text/javascript"></script>
		<script src="../../js/MIDI/inc/stream.js" type="text/javascript"></script>
		<script src="../../js/MusicalUtils.js" type="text/javascript"></script>
		<script type="text/javascript">
			var MidiIO = null;

			var PinaoConfig = {
				NoteStart: 21,
				NoteEnd: 108,
				MiddleC: 60,
				KeySerials: {
					White: [0, 2, 4, 5, 7, 9, 11],
					BlackPosition: {
						1: 0.94,
						3: 2.06,
						6: 3.92,
						8: 5,
						10: 6.08
					}
				},
				KeyWidth: 40,
				KeyHeight: 60,
				RangeKeyWidth: 11
			};


			var playMidi = function (data) {
				MIDI.Player.loadFile(data, MIDI.Player.start);
				$("#playback-play").attr("src", "/res/images/pause.png");
			};

			var toMinutesSeconds = function (millisec) {
				var minutes = parseInt(millisec / 60000);
				var seconds = parseInt((millisec - minutes * 60000) / 1000);

				return minutes + ":" + (seconds < 10 ? "0" : "") + seconds;
			};

			var checkPlugin = function (type) {
				for (var i = 0; i < navigator.plugins.length; ++i) {
					for (var j = 0; j < navigator.plugins[i].length; ++j) {
						if (navigator.plugins[i][j].type == type)
							return navigator.plugins[i];
					}
				}

				return null;
			};

			var refreshMidiInputDevices = function () {
				$("#input-device").empty();

				var inputs = MidiIO.getMIDIInputs();
				if (inputs) {
					inputs = inputs.split(",");
					console.log(inputs.length + " MIDI input device(s) detected.");

					for (var i in inputs) {
						$("#input-device").append("<option value='" + i + "'>" + inputs[i] + "</option>");
					}
					$("#input-device").attr("disabled", false);

					var connect = function (id) {
						MidiIO.addConnection(id);

						console.log("Connected input device:", inputs[id]);
					};

					connect($("#input-device").val());

					$("#input-device").unbind("change");
					$("#input-device").change(function () {
						if ($("#input-device").val() >= 0)
							connect($("#input-device").val());
					});
				}
				else {
					$("#input-device").append("<option value='-1'>No MIDI Input Device Detected.</option>");
					$("#input-device").attr("disabled", true);

					console.log("No MIDI input device detected.");
				}
			};

			var svg = function (selector) {
				return new $.svg._wrapperClass($(selector)[0]);
			};

			var addClass = function (elem, cls) {
				if(elem.length)
					elem.attr("class", elem.attr("class") + " " + cls);
			};

			var removeClass = function (elem, cls) {
				if (elem.length)
					elem.attr("class", elem.attr("class").replace(RegExp("\\s" + cls, "g"), ""));
			};

			var activeKey = function (key, volume) {
				if (volume === undefined)
					volume = 100;

				if (volume > 0)
					MIDI.noteOn(0, key.data("note"), volume);
				addClass(key, "active");
			};

			var deactiveKey = function (key, mute) {
				if (!mute)
					MIDI.noteOff(0, key.data("note"));
				removeClass(key, "active");
			};

			var noteToX = function (note) {
				var group = Musical.noteGroup(note);
				var pitch = Musical.notePitch(note);
				var pos = PinaoConfig.KeySerials.White.indexOf(pitch);
				if (pos < 0)
					pos = PinaoConfig.KeySerials.BlackPosition[pitch];

				return group * PinaoConfig.KeySerials.White.length + pos - 12;
			};

			var xToNote = function (x) {
				var pos = x + 12;
				var group = Math.floor(pos / 7);
				var pitch = PinaoConfig.KeySerials.White[pos % PinaoConfig.KeySerials.White.length];

				return group * 12 + pitch;
			};

			localStorage.KeyboardRangeLow = localStorage.KeyboardRangeLow || noteToX(PinaoConfig.NoteStart);
			localStorage.KeyboardRangeHigh = localStorage.KeyboardRangeHigh || (noteToX(PinaoConfig.NoteEnd) + 1);


			var resetlocalStorage = function () {
				localStorage.removeItem("KeyboardRangeLow");
				localStorage.removeItem("KeyboardRangeHigh");
			};

			var updateRangeMask = function () {
				var low = Number(localStorage.KeyboardRangeLow);
				var high = Number(localStorage.KeyboardRangeHigh);

				var keyboardLeft = $("#range-keyboard").offset().left - $("#range-bar").offset().left;
				var left = keyboardLeft + low * PinaoConfig.RangeKeyWidth;
				var right = keyboardLeft + high * PinaoConfig.RangeKeyWidth;

				$("#range-mask-left").css("width", left - 2);
				$("#range-mask-right").css("left", right);
				$("#range-mask-middle").css("left", left);
				$("#range-mask-middle").css("width", right - left - 4);

				$("#keyboard-canvas, #score-canvas").css({
					left: 100 * (-low / (high - low)) + "%",
					width: 100 * ((noteToX(PinaoConfig.NoteEnd) + 1 - noteToX(PinaoConfig.NoteStart)) / (high - low)) + "%"
				});
			};

			var initializeRangeKeyboard = function () {
				var keyboardWhite = svg("#range-keyboard-white");
				var keyboardBlack = svg("#range-keyboard-black");
				for (var note = PinaoConfig.NoteStart; note <= PinaoConfig.NoteEnd; ++note) {
					var pitch = Musical.notePitch(note);
					var x = noteToX(note);
					if (PinaoConfig.KeySerials.White.indexOf(pitch) >= 0) {
						keyboardWhite.rect(x * PinaoConfig.RangeKeyWidth, 0, PinaoConfig.RangeKeyWidth, PinaoConfig.RangeKeyWidth * 3, 0, 0, { class: "key white-key", "data-note": note });
					}
					else {
						keyboardBlack.rect((x - 0.3) * PinaoConfig.RangeKeyWidth, 0, PinaoConfig.RangeKeyWidth * 0.6, PinaoConfig.RangeKeyWidth * 1.9, 0, 0, { class: "key black-key", "data-note": note });
					}
				}

				var keyboardLabels = svg("#range-keyboard-labels");
				keyboardLabels.text((noteToX(PinaoConfig.MiddleC) + 0.5) * PinaoConfig.RangeKeyWidth, PinaoConfig.RangeKeyWidth * 2.8, "C");

				$("#range-keyboard .key").mouseenter(function () {
					activeKey($(this), 60);
				});
				$("#range-keyboard .key").mouseleave(function () {
					deactiveKey($(this));
				});

				$("#range-canvas").css({
					width: $("#range-keyboard-white .key").length * PinaoConfig.RangeKeyWidth + 2,
					height: PinaoConfig.RangeKeyWidth * 3 + 2
				});

				$("#range-bar .mask").mousedown(function () {
					$(this).addClass("hold");

					return false;
				});

				$(window).mouseup(function () {
					$("#range-bar .mask").removeClass("hold");
				});

				$("#range-bar").mousemove(function () {
					var delta = event.webkitMovementX / PinaoConfig.RangeKeyWidth;

					var changed = false;

					var low = Number(localStorage.KeyboardRangeLow);
					var high = Number(localStorage.KeyboardRangeHigh);

					if ($("#range-mask-left").is(".hold")) {
						low += delta;
						low = Math.min(low, high - 7);

						changed = true;
					}

					if ($("#range-mask-right").is(".hold")) {
						high += delta;
						high = Math.max(high, low + 7);

						changed = true;
					}

					if ($("#range-mask-middle").is(".hold")) {
						low += delta;
						low = Math.min(low, high - 7);
						high += delta;
						high = Math.max(high, low + 7);

						changed = true;
					}

					low = Math.max(low, noteToX(PinaoConfig.NoteStart) - 10);
					high = Math.min(high, noteToX(PinaoConfig.NoteEnd) + 10);

					if (changed) {
						localStorage.KeyboardRangeLow = low;
						localStorage.KeyboardRangeHigh = high;

						updateRangeMask();
					}
				});
			};

			var initializeKeyboard = function () {
				$("#keyboard-canvas").attr("viewBox", "0 0 " + PinaoConfig.KeyWidth * (noteToX(PinaoConfig.NoteEnd) + 1) + " 60");
				$("#keyboard-canvas").attr("height", PinaoConfig.KeyHeight + 2);

				$("#score-canvas").attr("viewBox", "0 0 " + PinaoConfig.KeyWidth * (noteToX(PinaoConfig.NoteEnd) + 1) + " " + ($("#score-canvas").height() - 2));

				var keyboardWhite = svg("#keyboard-white");
				var keyboardBlack = svg("#keyboard-black");
				for (var note = PinaoConfig.NoteStart; note <= PinaoConfig.NoteEnd; ++note) {
					var pitch = Musical.notePitch(note);
					var x = noteToX(note);
					if (PinaoConfig.KeySerials.White.indexOf(pitch) >= 0) {
						keyboardWhite.rect(x * PinaoConfig.KeyWidth, 0, PinaoConfig.KeyWidth, PinaoConfig.KeyHeight, 4, 4, { class: "key white-key", "data-note": note });
					}
					else {
						keyboardBlack.rect((x - 0.25) * PinaoConfig.KeyWidth, 0, PinaoConfig.KeyWidth * 0.5, PinaoConfig.KeyHeight * 0.63, 4, 4, { class: "key black-key", "data-note": note });
					}
				}

				var keyboardLabels = svg("#keyboard-labels");
				//keyboardLabels.text((noteToX(PinaoConfig.MiddleC) + 0.5) * PinaoConfig.KeyWidth, PinaoConfig.KeyHeight * 0.9, "C");

				$("#keyboard .key").mousedown(function () {
					activeKey($(this), 100);

					return false;
				});
				$("#keyboard .key").mouseup(function () {
					deactiveKey($(this));
				});
				$("#keyboard .key").mouseenter(function () {
					if (event.which == 1)
						activeKey($(this), 100);
				});
				$("#keyboard .key").mouseleave(function () {
					if (event.which == 1)
						deactiveKey($(this));
				});
			};

			var updateLayout = function () {
				//$("#score-canvas").attr("height", $("body").innerHeight() - $("#header").outerHeight() - $("#keyboard-canvas").outerHeight());
				//$("#score-canvas").css("top", $("keyboard-canvas").outerHeight());
			};

			$(function () {
				$("body, body *").each(function (i, elem) {
					elem.ondrop = function (e) {
						e.preventDefault();
						return false;
					};
				});

				MIDI.loadPlugin({
					soundfontUrl: "../../soundfont/",
					instrument: "acoustic_grand_piano",
					callback: function () {
						console.log("Web MIDI loaded.");
						$("#loading").fadeOut(800);

						if (localStorage.SourceData) {
							$("#playback-source").text(localStorage.SourceName);
							MIDI.Player.loadFile(localStorage.SourceData, function () {
								MIDI.Player.currentTime = MIDI.Player.endTime * localStorage.PlaybackProgress;
							});
						}

						$("#playback-play").click(function () {
							if (MIDI.Player.playing) {
								MIDI.Player.pause();

								$("#playback-play").attr("src", "/res/images/play.png");
							}
							else {
								if (MIDI.Player.currentData) {
									MIDI.Player.resume();

									$("#playback-play").attr("src", "/res/images/pause.png");
								}
							}
						});

						$("body, body *").each(function (i, elem) {
							elem.ondragover = function (e) {
								$("body").addClass("drag-hover");
								e.preventDefault();
							};
							elem.ondragleave = function () {
								$("body").removeClass("drag-hover");
							};
							elem.ondrop = function (e) {
								$("body").removeClass("drag-hover");

								if (e.dataTransfer.files[0].type == "audio/mid") {
									var fr = new FileReader();
									fr.onloadend = function (e) {
										playMidi(e.currentTarget.result);

										localStorage.SourceData = e.currentTarget.result;
									};
									fr.readAsDataURL(e.dataTransfer.files[0]);
									$("#playback-source").text(e.dataTransfer.files[0].name);

									localStorage.SourceName = e.dataTransfer.files[0].name;
								}

								e.preventDefault();
								return false;
							};
						});

						MIDI.Player.addListener(function (data) {
							//console.log(data);
							var key = $("#keyboard .key[data-note='" + data.note + "']");
							var key2 = $("#range-keyboard .key[data-note='" + data.note + "']");

							switch (data.message) {
								case 144:
									activeKey(key, 0);
									activeKey(key2, 0);

									break;
								case 128:
									deactiveKey(key, true);
									deactiveKey(key2, true);

									break;
							}
						});

						MIDI.Player.setAnimation(function (data, element) {
							$("#playback-progress-cursor").css("width", (data.now * 100 / data.end) + "%");
							$("#playback-time-text").text(toMinutesSeconds(data.now * 1000));

							localStorage.PlaybackProgress = data.now / data.end;

							if (data.now >= data.end) {
								MIDI.Player.stop();
								$("#playback-play").attr("src", "/res/images/play.png");
							}
						});

						$("#playback-progress").click(function () {
							if (MIDI.Player.data) {
								var progress = (event.x - $("#playback-progress").offset().left) / $("#playback-progress").width();

								var playing = MIDI.Player.playing;

								MIDI.Player.pause();
								MIDI.Player.currentTime = MIDI.Player.endTime * progress;
								if (playing)
									MIDI.Player.resume();
							}
						});

						$("#playback-progress").mousemove(function () {
							if (MIDI.Player.data) {
								var progress = (event.x - $("#playback-progress").offset().left) / $("#playback-progress").width();
								$("#playback-progress").attr("title", toMinutesSeconds(progress * MIDI.Player.endTime));
							}
						});
					}
				});

				initializeRangeKeyboard();

				initializeKeyboard();

				updateRangeMask();

				if (!checkPlugin("application/x-klstudio-midi"))
					console.warn("No MIDI NPAPI plugin installed.");
				else {
					console.log("MIDI NPAPI plugin detected.");

					$("#input-device-bar").fadeIn();

					MidiIO = $("#midi-pugin")[0];

					MidiIO.registerCallbackObject({
						printmessage: function (message) {
							console.log("MIDI in:", message.getTimeStamp(), message.getRawData().toString(16));

							if (message.isNoteOnOrOff()) {
								if (message.isNoteOn()) {
									var note = message.getNoteNumber();

									MIDI.noteOn(message.getChannel(), note, message.getVelocity());
									activeKey($("#keyboard .key[data-note='" + note + "']"));
								}
								else {
									var note = message.getNoteNumber();

									MIDI.noteOff(message.getChannel(), note);
									deactiveKey($("#keyboard .key[data-note='" + note + "']"));
								}
							}
						}
					});

					refreshMidiInputDevices();

					$("#input-device-refresh").click(refreshMidiInputDevices);

					$(window).bind("beforeunload", function () {
						MidiIO.cleanup();
						console.log("MIDI plugin cleanup.");
					});
				}

				updateLayout();

				$(window).resize(updateLayout);
			});
		</script>
	</head>
	<body>
		<div id="header">
			<p>
				<span id="playback">
					<span><input id="playback-play" type="image" src="/res/images/play.png" class="image-button" /></span>
					<span id="playback-time">
						<span id="playback-progress"><span id="playback-progress-cursor"></span></span>
						<span id="playback-time-text"></span>
					</span>
					<span id="playback-source">...</span>
				</span>
				<span id="input-device-bar">
					<select id="input-device" disabled="disabled">
					</select>
					<input id="input-device-refresh" class="image-button" type="image" src="/res/images/refresh.png" />
				</span>
			</p>
			<p id="range-controls">
				<span id="range-bar">
					<span id="range-mask-left" class="mask"></span>
					<span id="range-mask-middle" class="mask"></span>
					<span id="range-mask-right" class="mask"></span>
					<svg id="range-canvas">
						<g id="range-keyboard">
							<g id="range-keyboard-white"></g>
							<g id="range-keyboard-black"></g>
							<g id="range-keyboard-labels"></g>
						</g>
					</svg>
				</span>
			</p>
		</div>
		<svg id="keyboard-canvas" preserveAspectRatio="none">
			<g id="keyboard">
				<g id="keyboard-white"></g>
				<g id="keyboard-black"></g>
				<g id="keyboard-labels"></g>
			</g>
		</svg>
		<svg id="score-canvas" preserveAspectRatio="none"></svg>
		<div id="loading"></div>
		<embed id="midi-pugin" type="application/x-klstudio-midi" />
	</body>
</html>
