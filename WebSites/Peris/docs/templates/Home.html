<!DOCTYPE html>
<html>
	<head>
		<title>Peris</title>
		<link href="/static/viewer.css" rel="stylesheet" type="text/css">
		<style>
			html
			{
				background: #000;
				color: #eee;
				height: 100%;
				font: 13px/20px "Lucida Grande", Arial, sans-serif;
			}

			body
			{
				margin: 0;
				height: 100%;
			}

			#sider
			{
				background: #062238;
				width: 10%;
				height: 100%;
				float: left;
			}

			#main
			{
				width: 90%;
				height: 100%;
				float: left;
			}

			#query-bar
			{
				background: #063609;
				height: 10%;
				width: 100%;
				position: relative;
				border-bottom: 2px solid #063609;
				box-sizing: border-box;
			}

			#viewer
			{
				height: 90%;
				overflow-x: hidden;
				overflow-y: auto;
			}

			#query
			{
				display: inline-block;
				height: 100%;
				float: right;
				width: 8%;
				background: #222;
				color: #666;
				font-size: 8vh;
				line-height: 100%;
				border-color: #444;
			}

			#query:active
			{
				background: #422;
			}

			#log
			{
				display: inline-block;
				height: 100%;
				float: right;
				width: 50%;
			}

			#sql
			{
				display: inline-block;
				box-sizing: border-box;
				height: 100%;
				position: absolute;
				width: 39%;
				background: #000;
				color: #888;
				border: none;
				padding: 0.2em;
			}

			#sql:focus
			{
				color: #ccc;
			}

			#log
			{
				margin: 0;
				overflow-y: auto;
			}

			#log .quote
			{
				display: inline-block;
				float: right;
				margin-left: 2em;
				padding-right: 0.4em;
				color: #888;
				font-style: italic;
			}

			#log .error .quote
			{
				color: #d77;
			}

			#log em
			{
				font-weight: bold;
			}

			#log li
			{
				color: #aaa;
			}

			#log li.error
			{
				color: #f66;
			}

			#log li.error:first-child
			{
				color: #f00;
			}

			#log li:first-child
			{
				color: #fff;
			}

			#log li:nth-child(odd)
			{
				background: rgba(255, 255, 255, 0.1);
			}

			#log li:nth-child(even)
			{
				background: rgba(0, 0, 0, 0.1);
			}

			#note-list
			{
				font-size: 20px;
				font-weight: bold;
				color: #aae;
			}

			#note-list li
			{
				height: 30px;
			}

			#note-list a
			{
				color: #aae;
				text-decoration: none;
			}
		</style>
		<script src="/static/jquery.min.js" type="text/javascript"></script>
		<script src="/static/viewer.js" type="text/javascript"></script>
		<script>
			var viewer;

			var parseQueries = function (source) {
				var m = source.match(/^.*\?(.*)$|^([^\?]*)$/);
				var q = m[1] || m[2];

				var queries = q.match(/[^#\&\?]+/g);

				var dict = {};
				for (var i in queries) {
					var pair = queries[i].split("=");
					dict[pair[0]] = pair[1];
				}

				return dict;
			};

			var log = function (msg, cls, quote) {
				console.log("[query " + cls + "]", $("<span>" + msg + "</span>").text());

				var quoteSummary = quote.length <= 80 ? quote : (quote.substring(0, 80) + "...");
				var quoteSpan = $("<span><a class='quote'>" + quoteSummary + "</a></span>");
				quoteSpan.find("a").attr({ "title": quote, "href": "#xsql=" + encodeURIComponent(quote) });

				$("#log").prepend("<li class='" + cls + "'>" + quoteSpan.html() + msg + "</li>");
			};

			var runSql = function (sql) {
				$("#viewer").addClass("loading");

				$.post("query", { sql: sql }, function (json, s, ajax) {
					if (json.result == "success") {
						var cost = Date.now() - ajax.userData.begin;

						log("<em>" + json.data.length + "</em> reocrds get, <em>" + (cost / 1000) + "</em> seconds cost.", "info", sql);

						viewer.update(json.data);
					}
					else if (json.result == "fail") {
						log($("<span/>").text(json.error).html(), "error", sql);

						viewer.clear();
					}
					else
						console.error("unexpect json result:", json);

					$("#viewer").removeClass("loading");
				}, "json")
				.fail(function () {
					console.error("SQL query request failed.");

					$("#viewer").removeClass("loading");
				})
				.userData = { begin: Date.now() };
			};

			var setViewerColumn = function (column) {
				localStorage.ViewerColumn = column;

				viewer.setColumn(column);
			};

			$(function () {
				viewer = new Viewer($("#viewer"));

				if (localStorage.ViewerColumn)
					viewer.setColumn(localStorage.ViewerColumn);

				var updateParams = function () {
					var params = parseQueries(location.hash);

					if (params.sql) {
						runSql(decodeURIComponent(params.sql));
					}

					if (params.xsql) {
						$("#sql").val(decodeURIComponent(params.xsql));
					}
				};

				window.onhashchange = updateParams;

				if (location.hash.length > 1)
					updateParams();

				$("#query").click(function () {
					location.hash = "sql=" + encodeURIComponent($("#sql").val());
				});
			});
		</script>
	</head>
	<body>
		<div id="sider">
			<ul id="note-list">
				<li><a href="#sql=select%20path%20from%20file_register%20left%20join%20album%20on%20file_register.hash%20%3D%20album.hash%0Awhere%20score%20is%20null">Raw</a></li>
				<li><a href="#sql=select%20path%20from%20file_register%20left%20join%20album%20on%20file_register.hash%20%3D%20album.hash%0Awhere%20score%20%3E%206%0Aorder%20by%20score%20desc">High Score</a></li>
			</ul>
		</div>
		<div id="main">
			<div id="query-bar">
				<ul id="log"></ul>
				<button id="query">&gt;</button>
				<textarea id="sql"></textarea>
			</div>
			<div id="viewer"></div>
		</div>
	</body>
</html>
