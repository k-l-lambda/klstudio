<!DOCTYPE html>
<html>
	<head>
		<title>Peris Importer</title>
		<style type="text/css">
			.error
			{
				color: #800;
			}

			.detail
			{
				font-weight: normal;
				font-size: 60%;
			}

			.clear
			{
				clear: both;
			}

			.section
			{
				margin: 1em;
			}

			#check-status.querying
			{
				color: #ccc;
			}

			#import-queue
			{
				margin: 0;
				padding: 0;
			}

			#import-queue li
			{
				float: left;
				list-style: none;
				padding: 0 6px;
				height: 170px;
				position: relative;
			}

			#import-queue img
			{
				width: 120px;
				height: 120px;
			}

			#import-queue p
			{
				margin: 0.2em 0;
			}

			.pending img
			{
				border: 2px solid #ccc;
			}

			.checking img
			{
				border: 2px solid #a2ff00;
			}

			.ready img
			{
				border: 1px solid rgba(0, 64, 192, 0.3);
			}

			.error img
			{
				border: 2px solid #ff0000;
			}

			#import-queue li .marker
			{
				position: absolute;
				right: 18px;
				bottom: 48px;
				display: inline-block;
				width: 18px;
				height: 18px;
				background-image: url(/static/icons.png);
			}

			#import-queue .pending .marker
			{
				background-position: 0 -250px;
			}

			#import-queue .checking .marker
			{
				background-position: 0 -100px;
			}

			#import-queue .ready .marker
			{
				background-position: 0 -150px;
			}

			#import-queue .error .marker
			{
				background-position: 0 -200px;
			}
		</style>
		<script src="/static/jquery.min.js" type="text/javascript"></script>
		<script src="/static/utils.js" type="text/javascript"></script>
		<script src="/static/ajax_queue.js" type="text/javascript"></script>
		<script type="text/javascript">
			var QUERY_LIST_INTERVAL = 30000;

			var queries = Peris.parseQueries(location.search);

			var ajax;
			var check_list = [];
			var ready_list = [];
			var last_query_list_time;

			var onIdle = function (capability) {
				// process pending files
				if (capability >= 2) {
					var pendings = $("#import-queue li.pending");
					if (pendings.length > 0) {
						var figure = $(pendings[0]);
						var path = figure.data("path");
						checkFile(path, figure);
					}
				}

				// process check list
				if (check_list.length > 0) {
					$("#check-status").html("<em>" + check_list.length + "</em> files in checking: <span class='detail'>" + check_list[0] + "</span>");

					if (ready_list.indexOf(check_list[0]) < 0) {
						(function (path) {
							ajax.getJSON("/query?query=file-info&path=" + encodeURIComponent(path), function (json) {
								if (json.result == "success") {
									if (!json.data) {
										console.log("New file found: " + path);

										addCheckFile(path);
									}
								}
								else if (json.result == "fail") {
									console.warn("query file info " + path + " failed:", json.error);
								}
								else
									console.error("unexpect json result:", json);

								ready_list.push(path);
							});
						})(check_list[0]);
					}

					check_list.splice(0, 1);
				}
				else {
					var now = new Date().getTime();
					if (now - last_query_list_time > QUERY_LIST_INTERVAL) {
						if (!$("#check-status").hasClass("querying"))
							queryDirList();
					}
					else {
						var waiting = Math.ceil((last_query_list_time + QUERY_LIST_INTERVAL - now) / 1000);
						$("#check-status").html("Waiting <em>" + waiting + "s</em>, query list again.");
					}
				}
			};

			var queryDirList = function () {
				$("#check-status").html("Querying directory <em>" + decodeURIComponent(queries.dir) + "</em>");
				$("#check-status").addClass("querying");

				var search = "";
				if (queries.dir)
					search += "dir=" + queries.dir + "&";
				if (queries.orderby)
					search += "orderby=" + queries.orderby;
				ajax.get("/list-dir?" + search, function (json) {
					$("#check-status").removeClass("querying");

					if (json.success) {
						check_list = json.files;
					}
					else {
						console.error("get list dir failed:", json.error);
						$("#check-status").html("<span class='error'>query directory failed: <span class='detail'>" + json.error + "</span></span>");
					}
				});

				last_query_list_time = new Date().getTime();
			};

			var updateFilesStatus = function () {
				$("#files-status").html("<em>" + $("#import-queue li.ready").length + " / " + $("#import-queue li").length + "</em> new files");
			};

			var addCheckFile = function (path) {
					var url = "/images/" + path;
				var name = path;
				if (name.length > 17)
					name = name.substr(0, 5) + ".." + name.substr(name.length - 10, 10);
				var figure = $("<li class='pending' data-path=" + path + "><p><span class='marker'></span><a target='_blank' href='" + url + "'><img src='" + url + "' /></a></p><p title='" + path + "'>" + name + "</p></li>");
				figure.appendTo("#import-queue");

				updateFilesStatus();
			};

			var checkFile = function (path, figure) {
				figure.removeClass("pending");
				figure.addClass("checking");

				ajax.post("/check-file", { path: path }, function (json) {
					figure.removeClass("checking");

					if (json.success) {
						console.log("check file success: ", json);

						figure.addClass("ready");
					}
					else {
						console.warn("check file failed: ", json);

						figure.addClass("error");
						figure.attr("title", json.error);
					}

					updateFilesStatus();
				});
			};

			$(function () {
				ajax = new ajax_queue({ onIdle: onIdle });

				queryDirList();
			});
		</script>
	</head>
	<body>
		<div class="section">
			<h2 id="check-status"></h2>
		</div>
		<div class="section">
			<h2 id="files-status"></h2>
			<ul id="import-queue"></ul>
			<div class="clear"></div>
		</div>
	</body>
</html>
