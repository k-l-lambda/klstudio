<!DOCTYPE html>
<html>
    <head>
        <title>follower</title>
        <style type="text/css">
            body
            {
                font-family: Verdana, Arial, Helvetica, sans-serif;
                margin: 0;
                font-size: 12px;
                overflow-y: hidden;
                position: fixed;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
            }

            #controllers
            {
                background-color: #eef;
                padding: 0.6em;
                font-size: 200%;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 100;
            }

            #viewer
            {
                position: relative;
                width: 100%;
                height: 100%;
                padding-top: 78px;
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                background-color: #111;
                overflow-y: hidden;
            }

            #viewer > div
            {
                position: absolute;
                width: 50%;
                height: 100%;
                padding-top: 78px;
                border-left: 2px solid #343;
            }

            #criterion-area
            {
                left: 0;
            }

            #sample-area
            {
                right: 0;
            }

            .keyboard
            {
                position: absolute;
                top: 70px;
                width: 100%;
            }

            .midi-file
            {
                min-width: 6em;
                height: 3em;
            }

            #criterion-file-input
            {
                display: none;
            }

            .midi-file.drag-hover
            {
            	border: 2px solid red;
            }

            .midi-file.loading
            {
            	color: #ccc;
            	background-color: #ff8;
            }

            .middle-wrapper
            {
                overflow: visible;
                position: relative;
                top: 50%;
                border-top: 1px #333 dashed;
            }

            #criterion-canvas, #sample-canvas
            {
                position: relative;
                width: 100%;
            }


            .matched .note-bar
            {
                stroke: #ff6;
                stroke-width: 2px;
            }

            .step-0 .note-bar
            {
            	fill: #ff0000;
            }

            .step-1 .note-bar
            {
            	fill: #ff6500;
            }

            .step-2 .note-bar
            {
            	fill: #ffb400;
            }

            .step-3 .note-bar
            {
            	fill: #ffe400;
            }

            .step-4 .note-bar
            {
            	fill: #eaff00;
            }

            .step-5 .note-bar
            {
            	fill: #6cff00;
            }

            .step-6 .note-bar
            {
            	fill: #00ff96;
            }

            .step-7 .note-bar
            {
            	fill: #00fff6;
            }

            .step-8 .note-bar
            {
            	fill: #008cff;
            }

            .step-9 .note-bar
            {
            	fill: #0003ff;
            }

            .step-10 .note-bar
            {
            	fill: #ae00ff;
            }

            .step-11 .note-bar
            {
            	fill: #f600ff;
            }


            .keyboard .white-key
            {
            	fill: white;
            	stroke: #333;
            	stroke-width: 1px;
            }

            .keyboard .black-key
            {
            	fill: black;
            }

            .keyboard .white-key:hover
            {
            	fill: #eef;
            }

            .keyboard .white-key.active
            {
            	fill: #aaf;
            }

            .keyboard .black-key:hover
            {
            	fill: #335;
            }

            .keyboard .black-key.active
            {
            	fill: #22d !important;
            }
        </style>
        <script src="../js/jquery.js" type="text/javascript"></script>
		<script src="../js/jquery.svg.js" type="text/javascript"></script>
		<script src="../js/MIDI/AudioDetect.js" type="text/javascript"></script>
		<script src="../js/MIDI/LoadPlugin.js" type="text/javascript"></script>
		<script src="../js/MIDI/Plugin.js" type="text/javascript"></script>
		<script src="../js/MIDI/Player.js" type="text/javascript"></script>
		<script src="../js/MIDI/Window/DOMLoader.XMLHttp.js" type="text/javascript"></script>
		<script src="../js/MIDI/Window/DOMLoader.script.js" type="text/javascript"></script>
		<script src="../js/MIDI/inc/WebMIDIAPI.js" type="text/javascript"></script>
		<script src="../js/MIDI/inc/Base64.js" type="text/javascript"></script>
		<script src="../js/MIDI/inc/base64binary.js" type="text/javascript"></script>
		<script src="../js/MIDI/inc/replayer.js" type="text/javascript"></script>
		<script src="../js/MIDI/inc/midifile.js" type="text/javascript"></script>
		<script src="../js/MIDI/inc/stream.js" type="text/javascript"></script>
        <script src="../js/MusicalUtils.js" type="text/javascript"></script>
        <script src="recorder.js" type="text/javascript"></script>
        <script src="MidiMatch.js" type="text/javascript"></script>
        <script type="text/javascript">
            var criterionMidiData = null;
            var criterionNotations = null;


            var Config = {
            	KeyWidth: 40,
                KeyHeight: 120,
            	ScoreHeightScale: 0.1,
                SampleCanvasLength: 10000000,
                PendingLatency: 800,
                SequenceResetInterval: 4000,
                ContextSpan: { left: -800, right: 800 },
                DistanceSigmoidFactor: 0.01,		// context compare time distance, sigmod x units per ms
				ContextRegressionDiffer: 0.01,		// context compare regression cost derivation default infinitesimal
				ContextRegressionBegin: 10,			// context compare regression begin boundary
				ContextRegressionEnd: 0.01,			// context compare regression cost end condition
				ConnectionBiasCostBenchmark: 800,	// how many ms bias result in cost = 1
				ConnectionClipIndex: 5,
				NullConnectionCost: 1,
            };

            var PianoConfig = {
            	PitchStart: 21,
            	PitchEnd: 108,
            	MiddleC: 60,
            	KeySerials: {
            		White: [0, 2, 4, 5, 7, 9, 11],
            		BlackPosition: {
            			1: 0.94,
            			3: 2.06,
            			6: 3.92,
            			8: 5,
            			10: 6.08
            		}
            	},
            };


            var PedalControllerTypes = {
				64: "Sustain",
				65: "Portamento",
				66: "Sostenuto",
				67: "Soft"
			};


            var KeyMap = $.parseJSON(localStorage.KeyMap || null) || {
            	// number keys
            	49: 60,
            	50: 62,
            	51: 64,
            	52: 65,
            	53: 67,
            	54: 69,
            	55: 71,
            	56: 72,
            	57: 74,
            	48: 76,
            	189: 77,
            	187: 79,

            	// up letters
            	81: 76,
            	87: 77,
            	69: 79,
            	82: 81,
            	84: 83,
            	89: 84,
            	85: 86,
            	73: 88,
            	79: 89,
            	80: 91,
            	219: 93,
            	221: 95,

            	// middle letters
            	65: 60,
            	83: 62,
            	68: 64,
            	70: 65,
            	71: 67,
            	72: 69,
            	74: 71,
            	75: 72,
            	76: 74,
            	186: 76,
            	222: 77,
            	220: 79,

            	// bottom letters
            	90: 48,
            	88: 50,
            	67: 52,
            	86: 53,
            	66: 55,
            	78: 57,
            	77: 59,
            	188: 60,
            	190: 62,
            	191: 64
            };

            var KeyStatus = {};


            var Rec;


            var loadMidiFile = function (data, name, filename, onload) {
                //MIDI.Player.timeWarp = timewarp[name];

                MIDI.Player.loadFile(data, function () {
                    criterionMidiData = MIDI.Player.data;

                    if (onload)
                        onload();
                });

                localStorage[name + "_data"] = data;
                localStorage[name + "_filename"] = filename;
            };


            var svg = function (selector) {
				return new $.svg._wrapperClass($(selector)[0]);
			};


            var parseMidiNotation = function (data) {
            	var channelStatus = [];
            	var pedalStatus = {};
            	var pedals = {};
            	var channels = [];
            	var bars = [];
            	var time = 0;
            	var millisecondsPerBeat = 60000 / 120;
            	var beats = 0;
            	var tempos = 4;
            	var tempoIndex = 0;
            	var keyRange = {};
            	var ticks = 0;

            	for (var n = 0; n < data.length; ++n) {
            		ticks += data[n][0].ticksToEvent;

            		if (data[n][1] > 0) {
            			var deltaBeats = data[n][1] / millisecondsPerBeat;
            			for (var b = Math.ceil(beats) ; b < beats + deltaBeats; ++b) {
            				var t = time + (b - beats) * millisecondsPerBeat;
            				bars.push({ time: t, index: tempoIndex % tempos });

            				++tempoIndex;
            			}

            			beats += deltaBeats;
            		}

            		time += data[n][1];

            		var event = data[n][0].event;
            		switch (event.type) {
            			case "channel":
            				channelStatus[event.channel] = channelStatus[event.channel] || [];

            				switch (event.subtype) {
            					case "noteOn":
            						pitch = event.noteNumber - (MIDI.Player.MIDIOffset || 0);
            						if (channelStatus[event.channel][pitch])
            							console.warn("unexpected noteOn: ", n, time, event);
            						channelStatus[event.channel][pitch] = { startTick: ticks, start: time, velocity: event.velocity };

            						keyRange.low = Math.min(keyRange.low || pitch, pitch);

            						break;
            					case "noteOff":
            						pitch = event.noteNumber - (MIDI.Player.MIDIOffset || 0);

            						channels[event.channel] = channels[event.channel] || [];

            						var status = channelStatus[event.channel][pitch];
            						if (!status)
            							console.warn("unexpected noteOff: ", n, time, event);
            						else {
            							channels[event.channel].push({ startTick: status.startTick, endTick: ticks, pitch: pitch, start: status.start, duration: time - status.start, velocity: status.velocity });
            							channelStatus[event.channel][pitch] = null;
            						}

            						keyRange.high = Math.max(keyRange.high || pitch, pitch);

            						break;
            					case "controller":
            						switch (event.controllerType) {
            							// pedal controllers
            							case 64:
            							case 65:
            							case 66:
            							case 67:
            								var pedalType = PedalControllerTypes[event.controllerType];

            								pedalStatus[event.channel] = pedalStatus[event.channel] || {};
            								pedals[event.channel] = pedals[event.channel] || [];

            								var status = pedalStatus[event.channel][pedalType];

            								if (event.value > 0) {
            									if (!status)
            										pedalStatus[event.channel][pedalType] = { start: time, value: event.value };
            								}
            								else {
            									if (status) {
            										pedals[event.channel].push({ type: pedalType, start: status.start, duration: time - status.start, value: status.value });

            										pedalStatus[event.channel][pedalType] = null;
            									}
            								}

            								break;
            						}

            						break;
            				}

            				break;
            			case "meta":
            				switch (event.subtype) {
            					case "setTempo":
            						millisecondsPerBeat = event.microsecondsPerBeat / 1000;
            						//beats = Math.round(beats);

            						break;
            					case "timeSignature":
            						tempos = event.numerator;
            						tempoIndex = 0;

            						break;
            				}

            				break;
            		}
            	}


            	var notes = [];
            	for (var c in channels) {
            		for (var n in channels[c]) {
            			notes.push(channels[c][n]);
            		}
            	}
            	notes.sort(function (n1, n2) {
            		return n1.start - n2.start;
            	});

            	for (var i in notes)
            		notes[i].index = Number(i);


            	var pitchMap = [];
            	for (var c in channels) {
            		for (var n in channels[c]) {
            			var pitch = channels[c][n].pitch
            			pitchMap[pitch] = pitchMap[pitch] || [];

            			pitchMap[pitch].push(channels[c][n]);
            		}
            	}

            	for (var pitch in pitchMap)
            		pitchMap[pitch].sort(function (n1, n2) {
            			return n1.start - n2.start;
            		});

            	return { channels: channels, notes: notes, pitchMap: pitchMap, pedals: pedals, bars: bars, endTime: time, keyRange: keyRange };
            };


            var pickMidiFile = function (file, elem) {
                if (file && (file.type == "audio/mid" || file.type == "audio/midi")) {
                    var fr = new FileReader();
                    fr.onloadend = function (e) {
                        elem.text(file.name);
                        elem.addClass("loading");

                        loadMidiFile(e.currentTarget.result, elem.data("name"), file.name, function () {
                            elem.removeClass("loading");

                            console.log(name + " MIDI file loaded:", file.name);

                            criterionNotations = parseMidiNotation(criterionMidiData);
                            paintScore("#criterion-score", criterionNotations);

                            MidiMatch.genNotationContext(criterionNotations);
                        });
                    };
                    fr.readAsDataURL(file);
                }
            };


            var noteOn = function (data) {
            	MIDI.noteOn(data.channel, data.pitch, data.velocity);

            	$(".keyboard .key[data-note='" + data.pitch + "']").addClass("active");

            	/*var bar = $(".note-bar[data-note='" + data.pitch + "']");
            	bar.addClass("active");
            	bar.css("opacity", velocityToOpacity(data.velocity));*/

                Rec.onNoteOn(data);
            };

            var noteOff = function (data) {
            	MIDI.noteOff(data.channel, data.pitch);

            	$(".keyboard .key[data-note='" + data.pitch + "']").removeClass("active");

            	/*var bar = $(".note-bar[data-note='" + data.pitch + "']");
            	barremoveClass("active");
            	bar.css("opacity", "");*/

                Rec.onNoteOff(data);
            };


            var pitchToX = function (pitch) {
            	var group = Musical.noteGroup(pitch);
            	var step = Musical.notePitch(pitch);
            	var pos = PianoConfig.KeySerials.White.indexOf(step);
            	if (pos < 0)
            		pos = PianoConfig.KeySerials.BlackPosition[step];

            	return group * PianoConfig.KeySerials.White.length + pos - 12;
            };


            var initializeKeyboard = function (canvas) {
                var canvasWidth = Config.KeyWidth * (pitchToX(PianoConfig.PitchEnd) + 1);
				canvas.attr("viewBox", "0 0 " + canvasWidth + " " + Config.KeyHeight);
				//canvas.attr("height", Config.KeyHeight + 2);

				var keyboardWhite = svg(canvas.find(".keyboard-white"));
				var keyboardBlack = svg(canvas.find(".keyboard-black"));
				for (var note = PianoConfig.PitchStart; note <= PianoConfig.PitchEnd; ++note) {
					var pitch = Musical.notePitch(note);
					var x = pitchToX(note);
					if (PianoConfig.KeySerials.White.indexOf(pitch) >= 0) {
						keyboardWhite.rect(x * Config.KeyWidth, 0, Config.KeyWidth, Config.KeyHeight, 4, 4, { class: "key white-key pitch-" + pitch, "data-note": note });
					}
					else {
						keyboardBlack.rect((x - 0.25) * Config.KeyWidth, 0, Config.KeyWidth * 0.5, Config.KeyHeight * 0.63, 4, 4, { class: "key black-key pitch-" + pitch, "data-note": note });
					}
				}


				$(".keyboard .key").mousedown(function () {
					noteOn({channel: 0, pitch: $(this).data("note"), velocity: 100});

					return false;
				});
				$(".keyboard .key").mouseup(function () {
					noteOff({ channel: 0, pitch: $(this).data("note") });
				});
				$(".keyboard .key").mouseenter(function () {
					if (event.which == 1)
						noteOn({ channel: 0, pitch: $(this).data("note"), velocity: 100 });
				});
				$(".keyboard .key").mouseleave(function () {
					if (event.which == 1)
						noteOff({ channel: 0, pitch: $(this).data("note") });
				});
			};


            var paintNote = function (note, group, options) {
                options = options || {};

                var step = Musical.notePitch(note.pitch);
                var is_white = PianoConfig.KeySerials.White.indexOf(step) >= 0;

                var width = is_white ? (Config.KeyWidth - 2) : Config.KeyWidth * 0.6;

                var start = note.start;
                if (options.timeOffset)
                    start += options.timeOffset;

                var left = pitchToX(note.pitch) * Config.KeyWidth - (is_white ? -1 : width / 2);
                var top = start * Config.ScoreHeightScale;
                var height = note.duration * Config.ScoreHeightScale;

                note.position = { x: left + Config.KeyWidth * 0.5, y: top };

                note.graph = note.graph || {}

                var note_elem = group.group({ class: "note " + (is_white ? "white" : "black") + " step-" + step + (note.matched ? " matched" : ""), "data-index": options.index });
                var note_group = svg(note_elem);

                var cornorRadius = is_white ? 5 : 0;

                note.graph.group = note_elem;
                note.graph.bar = note_group.rect(left, top, width, height, cornorRadius, cornorRadius, { class: "note-bar" });
            };

            var paintScore = function (group_name, notations) {
				$(group_name).html("");

				var canvasWidth = Config.KeyWidth * (pitchToX(PianoConfig.PitchEnd) + 1);
				$(group_name).parent().attr("viewBox", "0 0 " + (canvasWidth) + " " + (notations.endTime * Config.ScoreHeightScale));
                $(group_name).parent().attr("height", notations.endTime * Config.ScoreHeightScale + 2);

				var group = svg(group_name);

				for (var i in notations.notes) {
					var note = notations.notes[i];

                    paintNote(note, group, {index: i});
				}
			};


            var scrollSampleCanvas = function() {
                var now = new Date().getTime();

                var offsetY = now % Config.SampleCanvasLength + 1200 / Config.ScoreHeightScale;
                $("#sample-canvas").css("top", -offsetY * Config.ScoreHeightScale);
            };


            var WorkSequence = [];
            var workingIndex = 0;


            var matchNote = function(index) {
                var note = WorkSequence[index];
                if (!note)
                    return;

                MidiMatch.genNoteContext(WorkSequence, index);

                var second_best_node = note.matches[1] || note.matches[0];
                var second_best_node_cost = second_best_node.totalCost();

                var endNode = new MidiMatch.Node();

                for (var ii in note.matches) {
                	var node = note.matches[ii];
                	if (node.totalCost() - second_best_node_cost < 1 || ii < Config.ConnectionClipIndex) {
                		if (WorkSequence.length > index + 1) {
                             var next_note = WorkSequence[index + 1];
                             for (var i in next_note.matches)
         						next_note.matches[i].evaluateConnection(node);

                            next_note.matches = next_note.matches.sort(function(n1, n2) {
                                return n1.totalCost() - n2.totalCost();
                            });

                            endNode = next_note.matches[0];
                        }
                        else {
                            endNode.evaluateConnection(node);
                        }
                	}
                }

                var c_index = endNode.prev.c_note ? endNode.prev.c_note.index : -1;
                console.log("match:", index, c_index);

                note.matched = true;

                if (note.graph)
                    $(note.graph.group).addClass("matched");
            };


            var onNoteRecord = function(note) {
                MidiMatch.makeMatchNodes(note, criterionNotations);
                WorkSequence.push(note);

                var lastNote = WorkSequence[WorkSequence.length - 2];
                if (lastNote && lastNote.mathced)
                    matchNote(WorkSequence.length - 2);
            };

            var onNoteFinished = function(note) {
                //console.log("onNoteRecord:", note);
                var score = svg("#sample-score");

                var time = ((Rec.BeginTime + note.start) % Config.SampleCanvasLength + 1200 / Config.ScoreHeightScale) % Config.SampleCanvasLength;
                paintNote(note, score, {timeOffset: time - note.start});

                setTimeout(function() {
                    $(note.graph.group).remove();
                    note.graph = null;
                }, 2000 / Config.ScoreHeightScale);
            };


            var updateSequence = function() {
                var now = new Date().getTime();

                while (WorkSequence.length > workingIndex) {
                    var note = WorkSequence[workingIndex];

                    if (now - (note.start + Rec.BeginTime) > Config.PendingLatency) {
                        matchNote(workingIndex);
                        workingIndex++;
                    }
                    else
                        break;
                }

                var tail = WorkSequence[WorkSequence.length - 1];
                if (tail && now - (tail.start + Rec.BeginTime) > Config.SequenceResetInterval) {
                    WorkSequence = [];
                    workingIndex = 0;
                }
            };


            $(function(){
                MIDI.loadPlugin({
					soundfontUrl: "../soundfont/",
					instrument: "acoustic_grand_piano",
					callback: function () {
						console.log("Sound font loaded.");
					}
				});

                $(".midi-file").each(function (i, elem) {
                	elem.ondragover = function (e) {
                		$(elem).addClass("drag-hover");
                		e.preventDefault();
                	};
                	elem.ondragleave = function () {
                		$(elem).removeClass("drag-hover");
                	};

                	elem.ondrop = function (e) {
                		$(elem).removeClass("drag-hover");

                		pickMidiFile(e.dataTransfer.files[0], $(elem));

                		e.preventDefault();
                		return false;
                	};
                });

                $("#criterion-file").click(function () {
                	$("#criterion-file-input").click();
                });

                $("#criterion-file-input").change(function () {
                	if (event.target.files[0])
                		pickMidiFile(event.target.files[0], $("#criterion-file"));
                });

                initializeKeyboard($("#criterion-area .keyboard"));
                initializeKeyboard($("#sample-area .keyboard"));

                var canvasWidth = Config.KeyWidth * (pitchToX(PianoConfig.PitchEnd) + 1);
                var canvasHeight = Config.SampleCanvasLength * Config.ScoreHeightScale + 2400;
                $("#sample-canvas").attr("viewBox", "0 0 " + (canvasWidth) + " " + (canvasHeight));
                $("#sample-canvas").attr("height", canvasHeight + 2);
                var scrollHandle = setInterval(scrollSampleCanvas, 30);

                Rec = new Recorder({on: true, onNoteCreated: onNoteRecord, onNoteFinished: onNoteFinished});

                var updateHandle = setInterval(updateSequence, 50);

                $("#pause").click(function() {
                    Rec.toggleRecord();

                    var paused = !Rec.isRecording();
                    if (paused) {
                        $("#pause").removeClass("paused");
                        clearInterval(updateHandle);
                        clearInterval(scrollHandle);
                    }
                    else {
                        $("#pause").addClass("paused");
                        updateHandle = setInterval(updateSequence, 50);
                        scrollHandle = setInterval(scrollSampleCanvas, 30);
                    }

                    $("#pause").text(paused ? "RESTART" : "PAUSE");
                });


                if (localStorage.criterion_data) {
                	loadMidiFile(localStorage.criterion_data, "criterion", localStorage.criterion_filename, function() {
                        criterionNotations = parseMidiNotation(criterionMidiData);
                        paintScore("#criterion-score", criterionNotations);

                        MidiMatch.genNotationContext(criterionNotations);
                    });
                	$("#criterion-file").text(localStorage.criterion_filename);
                }


                // keyboard play
                $(document).keydown(function () {
                	if (!event.ctrlKey && KeyMap[event.keyCode]) {
                		if (!KeyStatus[event.keyCode]) {	// to avoid auto-repeat
                			noteOn({ channel: 0, pitch: KeyMap[event.keyCode] + (event.shiftKey ? 1 : 0), velocity: 100 });

                			KeyStatus[event.keyCode] = true;

                			event.preventDefault();
                		}
                	}
                });

                $(document).keyup(function () {
                	if (!event.ctrlKey && KeyMap[event.keyCode]) {
                		noteOff({ channel: 0, pitch: KeyMap[event.keyCode] + (event.shiftKey ? 1 : 0) });

                		KeyStatus[event.keyCode] = false;
                	}
                });
            });
        </script>
    </head>
    <body>
        <div id="controllers">
            Criterion: <button id="criterion-file" class="midi-file" data-name="criterion">...</button> <input id="criterion-file-input" type="file" accept="audio/mid,audio/midi" />
            <button id="pause">PAUSE</button>
        </div>
        <div id="viewer">
            <div id="criterion-area">
                <div class="middle-wrapper">
                    <svg id="criterion-canvas" preserveAspectRatio="none">
        				<g id="criterion-score"></g>
        			</svg>
                </div>
                <svg class="keyboard">
                    <g class="keyboard-white"></g>
    				<g class="keyboard-black"></g>
                </svg>
            </div>
            <div id="sample-area">
                <div class="middle-wrapper">
                    <svg id="sample-canvas" preserveAspectRatio="none">
                        <g id="sample-score"></g>
                    </svg>
                </div>
                <svg class="keyboard">
                    <g class="keyboard-white"></g>
    				<g class="keyboard-black"></g>
                </svg>
            </div>
        </div>
    </body>
</html>
