import{V as a,ae as u,a as h,E as l,af as f,ai as d,c}from"./three.module-x1Cfo4R0.js";import{a as m}from"./delay-DTFr9Qec.js";import{C as b}from"./cubeObject-CTeWqh_v.js";import{_ as w,c as g,o as M,j as p}from"./router-JVv0ElFj.js";const T=["#f90","#d00","#ff2","white","blue","#0e0","black"].map(e=>new c({color:new h(e)})),A=["#fc6","#d66","#ff8","#ccc","#44f","#6e6","#222"].map(e=>new c({color:new h(e)})),x=e=>{const t=[Math.abs(e.x),Math.abs(e.y),Math.abs(e.z)],s=Math.max(...t);return t[0]===s?e.x>0?1:0:t[1]===s?e.y>0?3:2:e.z>0?5:4},S=[new a(-1.5,0,0),new a(1.5,0,0),new a(0,-1.5,0),new a(0,1.5,0),new a(0,0,-1.5),new a(0,0,1.5)],z={name:"cube3",props:{size:{type:Object,default:()=>({width:800,height:800})},code:String,meshSchema:{type:String,default:"cube"},material:{type:[Object,Array],default:()=>T},highlightMaterial:{type:[Object,Array],default:()=>A}},mounted(){this.rendererActive=!0,this.initializeRenderer(),this.cube=new b({materials:this.material,onChange:e=>this.onChange(e),meshSchema:this.meshSchema}),this.scene.add(this.cube.graph),this.$emit("cubeCreated",this.cube),this.raycaster=new d,this.holdingAxis=null,this.$emit("sceneInitialized",this),this.render()},beforeUnmount(){this.rendererActive=!1},methods:{initializeRenderer(){this.renderer=new u({antialias:!0,canvas:this.$refs.canvas,alpha:!0}),this.renderer.setClearColor(new h("black"),0),this.renderer.setSize(this.size.width,this.size.height,!1),this.camera=new l(60,this.size.width/this.size.height,3,12),this.camera.position.set(0,0,6.4),this.camera.lookAt(0,0,0),this.scene=new f},async render(){let e=performance.now(),t=Math.floor(e/1e3),s=0,n=0;for(;this.rendererActive;){this.$emit("beforeRender",this),this.renderer.render(this.scene,this.camera),this.$emit("afterRender",this),++s;const r=performance.now();n=Math.max(n,r-e);const i=Math.floor(r/1e3);if(i>t){const o=s/(i-t);this.$emit("fps",{fps:o,stuck:n}),s=0,n=0,t=i}e=r,await m()}},normalizeScreenPoint(e){return new a(e.offsetX/this.$refs.canvas.clientWidth*2-1,1-e.offsetY/this.$refs.canvas.clientHeight*2,0)},raycastAxis(e){if(this.raycaster){const t=this.normalizeScreenPoint(e);this.raycaster.setFromCamera(t,this.camera);const s=this.raycaster.intersectObject(this.cube.graph,!0);if(s[0]){const n=this.cube.graph.worldToLocal(s[0].point);return x(n)}}return null},onMouseMove(e){if(this.cube)if(Number.isInteger(this.holdingAxis)&&e.buttons!==4){const s=this.normalizeScreenPoint(e).clone().sub(this.holdPosition.start),r=-this.holdPosition.start.clone().sub(this.holdPosition.pivot).normalize().clone().cross(s).z*3;this.cube.twistGraph(this.holdingAxis,r)}else switch(e.buttons){case 1:case 4:this.cube.graph.rotateOnWorldAxis(new a(0,1,0),e.movementX*.01),this.cube.graph.rotateOnWorldAxis(new a(1,0,0),e.movementY*.01);break;case 0:this.cube.cubeMeshes.forEach(s=>s.material=this.material);const t=this.raycastAxis(e);Number.isInteger(t)&&this.cube.algebra.faceIndicesFromAxis(t).forEach(n=>this.cube.cubeMeshes[n].material=this.highlightMaterial);break}},onMouseDown(e){switch(e.buttons){case 1:const t=this.raycastAxis(e);if(Number.isInteger(t)){const s=this.cube.graph.localToWorld(S[t].clone());s.project(this.camera),s.z=0,this.holdingAxis=t,this.holdPosition={pivot:s,start:this.normalizeScreenPoint(e)}}break}},onMouseUp(){Number.isInteger(this.holdingAxis)&&(this.cube.releaseGraph(),this.holdingAxis=null)},touchToOffsetPoint(e,t={buttons:0}){const s=this.$el.getBoundingClientRect();return{offsetX:e.pageX-s.x,offsetY:e.pageY-s.y,...t}},onTouchStart(e){this.rendererActive&&e.touches.length===1&&(this.onMouseDown(this.touchToOffsetPoint(e.touches[0],{buttons:1})),e.preventDefault())},onTouchMove(e){switch(e.touches.length){case 1:const t=this.touchToOffsetPoint(e.touches[0]);this.onMouseMove(t),this.lastTouchPoint={offsetX:t.offsetX,offsetY:t.offsetY},e.preventDefault();break;case 2:{const s=this.touchToOffsetPoint(e.touches[0],{buttons:1});this.lastTouchPoint&&(s.movementX=s.offsetX-this.lastTouchPoint.offsetX,s.movementY=s.offsetY-this.lastTouchPoint.offsetY,this.holdingAxis=null,this.onMouseMove(s)),this.lastTouchPoint={offsetX:s.offsetX,offsetY:s.offsetY}}e.preventDefault();break}},onTouchEnd(){this.onMouseUp(),this.lastTouchPoint=null},onChange(e){this.innerCode=e.encode(),this.$emit("update:code",this.innerCode)}},watch:{size(e){this.camera.aspect=e.width/e.height,this.camera.updateProjectionMatrix(),this.renderer.setSize(e.width,e.height,!1)},code(e){this.innerCode!==e&&this.cube.setState(e)}}},P=["width","height"];function y(e,t,s,n,r,i){return M(),g("canvas",{ref:"canvas",width:s.size.width,height:s.size.height,onMousemove:t[0]||(t[0]=(...o)=>i.onMouseMove&&i.onMouseMove(...o)),onMousedown:t[1]||(t[1]=p((...o)=>i.onMouseDown&&i.onMouseDown(...o),["prevent"])),onMouseup:t[2]||(t[2]=(...o)=>i.onMouseUp&&i.onMouseUp(...o)),onTouchstart:t[3]||(t[3]=(...o)=>i.onTouchStart&&i.onTouchStart(...o)),onTouchmove:t[4]||(t[4]=(...o)=>i.onTouchMove&&i.onTouchMove(...o)),onTouchend:t[5]||(t[5]=(...o)=>i.onTouchEnd&&i.onTouchEnd(...o))},null,40,P)}const k=w(z,[["render",y]]);export{k as C};
