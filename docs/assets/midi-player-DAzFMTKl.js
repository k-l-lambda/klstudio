import{r as C}from"./vue-resize-directive-CDf_Yp3t.js";import{g as S,f as c,d as k,u as _}from"./musicWidgetsBrowser.es-ry_tjTyi.js";import{_ as M,c as u,o as a,a as d,p as m,n as h,z as B,r as p,y as D,w as f,e as N,b as y,v as g,B as v,j as w,h as z}from"./router-JVv0ElFj.js";import{S as x}from"./store-input-C4hejk23.js";const H={name:"progress-bar",props:{cursor:Number,duration:{type:Number,validator:r=>r>0}},data(){return{indicator:null}},computed:{progress(){return this.cursor/this.duration}},methods:{onMouseMove(r){this.indicator=r.offsetX/this.$el.clientWidth,r.buttons===1&&this.emitCursor()},onMouseLeave(){this.indicator=null},emitCursor(){const r=this.cursor;this.$emit("update:cursor",this.indicator*this.duration),this.$emit("turnCursor",this.indicator*this.duration,r)},formatTime(r){if(!Number.isFinite(r)||r<0)return"--:--";const e=Math.floor(r/6e4),i=(r%6e4/1e3).toFixed(1).replace(/\.(\d+)$/,"<sub>.$1</sub>");return`${e}:${r%6e4/1e3<10?"0":""}${i}`}}},V={class:"timer"},A=["innerHTML"],L=["innerHTML"];function R(r,e,i,s,o,t){return a(),u("span",{class:"progress-bar",onMousemove:e[0]||(e[0]=(...l)=>t.onMouseMove&&t.onMouseMove(...l)),onMouseleave:e[1]||(e[1]=(...l)=>t.onMouseLeave&&t.onMouseLeave(...l)),onClick:e[2]||(e[2]=(...l)=>t.emitCursor&&t.emitCursor(...l))},[d("span",{class:"fill cursor",style:h({width:`${t.progress*100}%`})},null,4),o.indicator?(a(),u("span",{key:0,class:"fill indicator",style:h({width:`${o.indicator*100}%`})},null,4)):m("",!0),d("span",V,[d("span",{innerHTML:t.formatTime(i.cursor)},null,8,A),e[3]||(e[3]=B(" / ",-1)),d("span",{innerHTML:t.formatTime(i.duration)},null,8,L)])],32)}const U=M(H,[["render",R],["__scopeId","data-v-281ad074"]]),F=r=>{const i=[...new Uint8Array(r)].map(s=>String.fromCharCode(s)).join("");return btoa(i)},I=r=>{const i=atob(r).split("").map(s=>s.charCodeAt(0));return new Uint8Array(i).buffer},O={name:"midi-player",directives:{resize:C},components:{MidiRoll:S,ProgressBar:U,StoreInput:x},data(){return{dragHover:!1,player:null,viewTimeScale:.004,name:null,source:null,windowSize:{width:800,height:800}}},computed:{cursorTime:{get(){return this.player&&this.player.progressTime},set(r){this.player&&this.player.turnCursor(r)}}},created(){c.WebAudio.empty()&&c.loadPlugin({soundfontUrl:"./soundfont/",api:"webaudio"}).then(()=>console.log("Soundfont loaded.")),window.addEventListener("keydown",r=>{let e=!0;const i=document.activeElement.nodeName==="INPUT";switch(r.key){case" ":i||this.togglePlayer();break;default:e=!1}e&&r.preventDefault()})},mounted(){this.source&&this.loadMidiBuffer(I(this.source))},beforeDestroy(){this.player&&this.player.pause()},methods:{onResize(){this.windowSize={width:this.$el.clientWidth,height:this.$el.clientHeight}},async loadMidiFile(r){const e=await new Promise(i=>{const s=new FileReader;s.onload=()=>i(s.result),s.readAsArrayBuffer(r)});this.name=r.name,this.loadMidiBuffer(e)},async loadMidiBuffer(r){this.player&&(this.player.dispose(),this.player=null),this.source=F(r);const e=_.parseMidiData(r);this.updatePlayer(e)},updatePlayer(r){console.log("midi:",r),this.player=new k(r,{onMidi:(e,i)=>this.onMidi(e,i)})},async onDrop(r){this.dragHover=!1;const e=r.dataTransfer.files[0];if(e&&["audio/midi","audio/mid"].includes(e.type))this.loadMidiFile(e);else if(e&&e.type==="application/json"){const i=await new Promise(o=>{const t=new FileReader;t.onload=()=>o(t.result),t.readAsText(e)});this.name=e.name;const s=JSON.parse(i);this.updatePlayer(s)}},onMidi(r,e){if(!c.WebAudio.empty())switch(r.subtype){case"noteOn":c.noteOn(r.channel,r.noteNumber,r.velocity,e);break;case"noteOff":c.noteOff(r.channel,r.noteNumber,e);break}},togglePlayer(){this.player&&(this.player.isPlaying?this.player.pause():this.player.play())}}},W=["textContent"],j={key:0};function E(r,e,i,s,o,t){const l=p("StoreInput"),b=p("ProgressBar"),P=p("MidiRoll"),T=D("resize");return f((a(),u("div",{class:z(["midi-player",{hover:o.dragHover,empty:!o.player}]),onDragover:e[4]||(e[4]=w(n=>o.dragHover=!0,["prevent"])),onDragleave:e[5]||(e[5]=n=>o.dragHover=!1),onDrop:e[6]||(e[6]=w((...n)=>t.onDrop&&t.onDrop(...n),["prevent"]))},[d("header",null,[f(y(l,{modelValue:o.source,"onUpdate:modelValue":e[0]||(e[0]=n=>o.source=n),localKey:"midiPlayer.source"},null,8,["modelValue"]),[[g,!1]]),f(y(l,{modelValue:o.name,"onUpdate:modelValue":e[1]||(e[1]=n=>o.name=n),localKey:"midiPlayer.name"},null,8,["modelValue"]),[[g,!1]]),o.name?(a(),u("span",{key:0,textContent:v(o.name)},null,8,W)):m("",!0),o.player?(a(),u("button",{key:1,onClick:e[2]||(e[2]=(...n)=>t.togglePlayer&&t.togglePlayer(...n))},[o.player?(a(),u("i",j,v(o.player.isPlaying?"":""),1)):m("",!0)])):m("",!0),o.player&&o.player.notation?(a(),N(b,{key:2,cursor:t.cursorTime,"onUpdate:cursor":e[3]||(e[3]=n=>t.cursorTime=n),duration:o.player.notation.endTime},null,8,["cursor","duration"])):m("",!0)]),d("main",null,[y(P,{player:o.player,timeScale:o.viewTimeScale,height:400,width:o.windowSize.width},null,8,["player","timeScale","width"])])],34)),[[T,t.onResize]])}const G=M(O,[["render",E],["__scopeId","data-v-cd41bf0e"]]);export{G as default};
