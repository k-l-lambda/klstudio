import{c as q,o as S,a as E,p as N,e as rt,F as U,g as O,f as ot,B as R,h as st}from"./router-JVv0ElFj.js";class P{constructor(t){t instanceof Uint8Array?this.array=t:Array.isArray(t)?this.array=new Uint8Array(t):this.array=new Uint8Array(t),this.position=0}eof(){return this.position>=this.array.length}read(t){const e=this.array.slice(this.position,this.position+t);return this.position+=t,e}readString(t){return Array.from(this.read(t)).map(e=>String.fromCharCode(e)).join("")}readInt32(){const t=(this.array[this.position]<<24)+(this.array[this.position+1]<<16)+(this.array[this.position+2]<<8)+this.array[this.position+3];return this.position+=4,t}readInt16(){const t=(this.array[this.position]<<8)+this.array[this.position+1];return this.position+=2,t}readInt8(t){let e=this.array[this.position];return t&&e>127&&(e-=256),this.position+=1,e}readVarInt(){let t=0;for(;;){const e=this.readInt8();if(e&128)t+=e&127,t<<=7;else return t+e}}}class Z{constructor(t){Object.assign(this,t)}static parse(t){function e(p){const a=p.readString(4),k=p.readInt32();return{id:a,length:k,data:p.read(k)}}let r;function o(p){const a={deltaTime:null,type:null};a.deltaTime=p.readVarInt();let k=p.readInt8();if((k&240)===240)if(k===255){a.type="meta";const w=p.readInt8(),A=p.readVarInt();switch(w){case 0:if(a.subtype="sequenceNumber",A!==2)throw new Error("Expected length for sequenceNumber event is 2, got "+A);return a.number=p.readInt16(),a;case 1:return a.subtype="text",a.text=p.readString(A),a;case 2:return a.subtype="copyrightNotice",a.text=p.readString(A),a;case 3:return a.subtype="trackName",a.text=p.readString(A),a;case 4:return a.subtype="instrumentName",a.text=p.readString(A),a;case 5:return a.subtype="lyrics",a.text=p.readString(A),a;case 6:return a.subtype="marker",a.text=p.readString(A),a;case 7:return a.subtype="cuePoint",a.text=p.readString(A),a;case 32:if(a.subtype="midiChannelPrefix",A!==1)throw new Error("Expected length for midiChannelPrefix event is 1, got "+A);return a.channel=p.readInt8(),a;case 47:if(a.subtype="endOfTrack",A!==0)throw new Error("Expected length for endOfTrack event is 0, got "+A);return a;case 81:if(a.subtype="setTempo",A!==3)throw new Error("Expected length for setTempo event is 3, got "+A);return a.microsecondsPerBeat=(p.readInt8()<<16)+(p.readInt8()<<8)+p.readInt8(),a;case 84:if(a.subtype="smpteOffset",A!==5)throw new Error("Expected length for smpteOffset event is 5, got "+A);const M=p.readInt8();return a.frameRate={0:24,32:25,64:29,96:30}[M&96],a.hour=M&31,a.min=p.readInt8(),a.sec=p.readInt8(),a.frame=p.readInt8(),a.subframe=p.readInt8(),a;case 88:if(a.subtype="timeSignature",A!==4)throw new Error("Expected length for timeSignature event is 4, got "+A);return a.numerator=p.readInt8(),a.denominator=Math.pow(2,p.readInt8()),a.metronome=p.readInt8(),a.thirtyseconds=p.readInt8(),a;case 89:if(a.subtype="keySignature",A!==2)throw new Error("Expected length for keySignature event is 2, got "+A);return a.key=p.readInt8(),a.scale=p.readInt8(),a;case 127:return a.subtype="sequencerSpecific",a.data=p.readString(A),a;default:return a.subtype="unknown",a.data=p.readString(A),a}}else if(k===240){a.type="sysEx";const w=p.readVarInt();return a.data=p.readString(w),a}else if(k===247){a.type="dividedSysEx";const w=p.readVarInt();return a.data=p.readString(w),a}else throw new Error("Unrecognised MIDI event type byte: "+k);else{let w;k&128?(w=p.readInt8(),r=k):(w=k,k=r);const A=k>>4;switch(a.channel=k&15,a.type="channel",A){case 8:return a.subtype="noteOff",a.noteNumber=w,a.velocity=p.readInt8(),a;case 9:return a.noteNumber=w,a.velocity=p.readInt8(),a.velocity===0?a.subtype="noteOff":a.subtype="noteOn",a;case 10:return a.subtype="noteAftertouch",a.noteNumber=w,a.amount=p.readInt8(),a;case 11:return a.subtype="controller",a.controllerType=w,a.value=p.readInt8(),a;case 12:return a.subtype="programChange",a.programNumber=w,a;case 13:return a.subtype="channelAftertouch",a.amount=w,a;case 14:return a.subtype="pitchBend",a.value=w+(p.readInt8()<<7),a;default:throw new Error("Unrecognised MIDI event type: "+A)}}}let c=t;typeof t=="string"?c=new Uint8Array(t.split("").map(p=>p.charCodeAt(0))).buffer:c instanceof Uint8Array&&(c=c.buffer);const n=new P(c),s=e(n);if(s.id!=="MThd"||s.length!==6)throw new Error("Bad .mid file - header not found");const l=new P(s.data),u=l.readInt16(),h=l.readInt16(),d=l.readInt16();let y;if(d&32768)throw new Error("Expressing time division in SMTPE frames is not supported yet");y=d;const f={formatType:u,trackCount:h,ticksPerBeat:y},g=[];for(let p=0;p<f.trackCount;p++){const a=e(n);if(a.id!=="MTrk")throw new Error("Unexpected chunk - expected MTrk, got "+a.id);const k=new P(a.data),w=[];let A=!1;for(;!k.eof();){const M=o(k);w.push(M),M.subtype==="endOfTrack"&&(A=!0)}A||w.push({deltaTime:0,type:"meta",subtype:"endOfTrack"}),g.push(w)}return new Z({header:f,tracks:g})}}const H=i=>Z.parse(i);class J{constructor(){this.data=[]}write(t){for(let e=0;e<t.length;++e)this.data.push(t.charCodeAt(e))}writeInt32(t){this.data.push(t>>24&255),this.data.push(t>>16&255),this.data.push(t>>8&255),this.data.push(t&255)}writeInt16(t){this.data.push(t>>8&255),this.data.push(t&255)}writeInt8(t){this.data.push(t&255)}writeVarInt(t){const e=[];for(;t;)e.push(t&127),t>>=7;for(let r=e.length-1;r>=0;--r)this.data.push(e[r]|(r?128:0))}getBuffer(){return String.fromCharCode(...this.data)}getArrayBuffer(){return new Uint8Array(this.data)}}function at({header:i,tracks:t}){function e(n,s,l){console.assert(s.length===4,"chunk id must be 4 byte"),n.write(s),n.writeInt32(l.length),n.write(l)}function r(n,s){if(s.subtype!=="unknown")switch(n.writeVarInt(s.deltaTime),s.type){case"meta":switch(n.writeInt8(255),s.subtype){case"sequenceNumber":n.writeInt8(0),n.writeVarInt(2),n.writeInt16(s.number);break;case"text":n.writeInt8(1),n.writeVarInt(s.text.length),n.write(s.text);break;case"copyrightNotice":n.writeInt8(2),n.writeVarInt(s.text.length),n.write(s.text);break;case"trackName":n.writeInt8(3),n.writeVarInt(s.text.length),n.write(s.text);break;case"instrumentName":n.writeInt8(4),n.writeVarInt(s.text.length),n.write(s.text);break;case"lyrics":n.writeInt8(5),n.writeVarInt(s.text.length),n.write(s.text);break;case"marker":n.writeInt8(6),n.writeVarInt(s.text.length),n.write(s.text);break;case"cuePoint":n.writeInt8(7),n.writeVarInt(s.text.length),n.write(s.text);break;case"midiChannelPrefix":n.writeInt8(32),n.writeVarInt(1),n.writeInt8(s.channel);break;case"endOfTrack":n.writeInt8(47),n.writeVarInt(0);break;case"setTempo":n.writeInt8(81),n.writeVarInt(3),n.writeInt8(s.microsecondsPerBeat>>16&255),n.writeInt8(s.microsecondsPerBeat>>8&255),n.writeInt8(s.microsecondsPerBeat&255);break;case"smpteOffset":n.writeInt8(84),n.writeVarInt(5);var l={24:0,25:32,29:64,30:96}[s.frameRate];n.writeInt8(s.hour|l),n.writeInt8(s.min),n.writeInt8(s.sec),n.writeInt8(s.frame),n.writeInt8(s.subframe);break;case"timeSignature":n.writeInt8(88),n.writeVarInt(4),n.writeInt8(s.numerator),n.writeInt8(Math.log2(s.denominator)),n.writeInt8(s.metronome),n.writeInt8(s.thirtyseconds);break;case"keySignature":n.writeInt8(89),n.writeVarInt(2),n.writeInt8(s.key),n.writeInt8(s.scale);break;default:n.writeInt8(127),n.writeVarInt(s.data.length),n.write(s.data);break}break;case"sysEx":n.writeInt8(240),n.writeVarInt(s.data.length),n.write(s.data);break;case"dividedSysEx":n.writeInt8(247),n.writeVarInt(s.data.length),n.write(s.data);break;case"channel":switch(s.subtype){case"noteOff":n.writeInt8(144|s.channel),n.writeInt8(s.noteNumber),n.writeInt8(s.velocity);break;case"noteOn":n.writeInt8(128|s.channel),n.writeInt8(s.noteNumber),n.writeInt8(s.velocity);break;case"noteAftertouch":n.writeInt8(160|s.channel),n.writeInt8(s.noteNumber),n.writeInt8(s.amount);break;case"controller":n.writeInt8(176|s.channel),n.writeInt8(s.controllerType),n.writeInt8(s.value);break;case"programChange":n.writeInt8(192|s.channel),n.writeInt8(s.programNumber);break;case"channelAftertouch":n.writeInt8(208|s.channel),n.writeInt8(s.amount);break;case"pitchBend":n.writeInt8(224|s.channel),n.writeInt8(s.value&127),n.writeInt8(s.value>>7&127);break;default:throw new Error("Unrecognised MIDI event type: "+s.subtype)}break;default:throw new Error("Unrecognised event type: "+s.type)}}const o=new J,c=new J;c.writeInt16(i.formatType),c.writeInt16(t.length),c.writeInt16(i.ticksPerBeat),e(o,"MThd",c.getBuffer());for(let n=0;n<t.length;++n){const s=new J;for(let l=0;l<t[n].length;++l)r(s,t[n][l]);e(o,"MTrk",s.getBuffer())}return o.getArrayBuffer()}const Gt=Object.freeze(Object.defineProperty({__proto__:null,encodeMidiFile:at,parseMidiData:H},Symbol.toStringTag,{value:"Module"})),ct=(i,{timeWarp:t=1}={})=>{const e=[];let r=120;const o=i.header.ticksPerBeat;for(let u=0;u<i.tracks.length;u++)e[u]={nextEventIndex:0,ticksToNextEvent:i.tracks[u].length?i.tracks[u][0].deltaTime:null};function c(){let u=null,h=null,d=null;for(let y=0;y<e.length;y++)e[y].ticksToNextEvent!=null&&(u==null||e[y].ticksToNextEvent<u)&&(u=e[y].ticksToNextEvent,h=y,d=e[y].nextEventIndex);if(h!=null){const y=i.tracks[h][d];i.tracks[h][d+1]?e[h].ticksToNextEvent+=i.tracks[h][d+1].deltaTime:e[h].ticksToNextEvent=null,e[h].nextEventIndex+=1;for(let f=0;f<e.length;f++)e[f].ticksToNextEvent!=null&&(e[f].ticksToNextEvent-=u);return{ticksToEvent:u,event:y,track:h}}else return null}let n=null;const s=[];function l(){function u(){let h=0;n.ticksToEvent>0&&(h=n.ticksToEvent/o/(r/60)),n.event.type=="meta"&&n.event.subtype=="setTempo"&&(r=6e7/n.event.microsecondsPerBeat);const d=h*1e3*t||0;s.push([n,d]),n=c()}if(n=c())for(;n;)u()}return l(),s},lt=i=>{const t=new Map;return i.filter(([{event:e,ticksToEvent:r}])=>{if(r>0&&t.clear(),e.type!=="channel")return!0;const o=`${e.subtype}|${e.channel}|${e.noteNumber}`;return t.get(o)?!1:(t.set(o,e),!0)})},ut=i=>{const t=new Map,e=new Map,r=[];let o=-1;return i.forEach(([{event:c,ticksToEvent:n}],s)=>{if(n>0&&(o=s),c.type!=="channel")return;const l=`${c.channel}|${c.noteNumber}`;switch(c.subtype){case"noteOn":t.get(l)?e.set(l,o):t.set(l,o);break;case"noteOff":e.get(l)?(r.push([e.get(l),s]),e.delete(l)):t.delete(l);break}}),r.forEach((c,n)=>{for(let s=n-1;s>=0;--s){const l=r[s];if(l[1]<c[0])break;c[0]>l[0]&&++c[0]}}),r.forEach(([c,n])=>{if(n>=i.length-1||c<0)return;const s=i[n],l=i[n+1],u=i[c];if(!u[0].ticksToEvent){console.warn("invalid front index:",c,n,u);return}const h=u[1]/u[0].ticksToEvent;l[1]+=s[1],l[0].ticksToEvent+=s[0].ticksToEvent,s[0].ticksToEvent=u[0].ticksToEvent-1,u[0].ticksToEvent=1,s[1]=s[0].ticksToEvent*h,u[1]=u[0].ticksToEvent*h,i.splice(n,1),i.splice(c,0,s)}),i},ht={64:"Sustain",65:"Portamento",66:"Sostenuto",67:"Soft"};class V{static parseMidi(t,{fixOverlap:e=!0,logger:r=null}={}){const o=[],c={},n={},s=[],l=[];let u=0,h=6e5/120,d=0,y=4,f=0;const g={low:null,high:null};let p=0,a=0,k;const w=[],A=t.header.ticksPerBeat;let M=ct(t);e&&(M=lt(ut(M)));const W=M.map(T=>({data:T[0].event,track:T[0].track,deltaTime:T[1],deltaTicks:T[0].ticksToEvent}));let D=0;const nt=1;for(const T of W){if(p+=T.deltaTicks,a=Math.round(p*nt),T.deltaTicks>0){const I=T.deltaTicks/A;for(let v=Math.ceil(d);v<d+I;++v){const x=u+(v-d)*h;l.push({time:x,index:f%y}),++f}d+=I}u+=T.deltaTime,T.time=u,T.ticks=a;const b=T.data;switch(b.type){case"channel":switch(b.subtype){case"noteOn":{const I=b.noteNumber;o.push({channel:b.channel,pitch:I,startTick:a,start:u,velocity:b.velocity,beats:d,track:T.track}),g.low=Math.min(g.low||I,I),T.index=D,++D}break;case"noteOff":{const I=b.noteNumber;s[b.channel]=s[b.channel]||[];const v=o.findIndex(x=>x.channel==b.channel&&x.pitch==I);if(v>=0){const x=o.splice(v,1)[0];s[b.channel].push({channel:b.channel,startTick:x.startTick,endTick:a,pitch:I,start:x.start,duration:u-x.start,velocity:x.velocity,beats:x.beats,track:x.track,finger:x.finger})}else r&&r.debug&&r.debug("unexpected noteOff: ",u,b);g.high=Math.max(g.high||I,I)}break;case"controller":switch(b.controllerType){case 64:case 65:case 66:case 67:const I=ht[b.controllerType];c[b.channel]=c[b.channel]||{},n[b.channel]=n[b.channel]||[];const v=c[b.channel][I];v&&n[b.channel].push({type:I,start:v.start,duration:u-v.start,value:v.value}),c[b.channel][I]={start:u,value:b.value};break}break}break;case"meta":switch(b.subtype){case"setTempo":h=b.microsecondsPerBeat/1e3,w.push({tempo:b.microsecondsPerBeat,tick:a,time:u});break;case"timeSignature":y=b.numerator,f=0;break;case"text":if(!k&&/^find-corres:/.test(b.text)){const I=b.text.match(/:([\d\,-]+)/);k=(I&&I[1]||"").split(",").map(v=>Number(v))}else if(/fingering\(.*\)/.test(b.text)){const[I,v]=b.text.match(/\((.+)\)/),x=Number(v);if(!Number.isNaN(x)){const j=o[o.length-1];j&&(j.finger=x);const L=W.find(it=>it.index==D-1);L&&(L.data.finger=x)}}break;case"copyrightNotice":r&&r.log&&r.log("MIDI copyright:",b.text);break}break}}return o.forEach(T=>{r&&r.debug&&r.debug("unclosed noteOn event at",T.startTick,T),s[T.channel]=s[T.channel]||[],s[T.channel].push({startTick:T.startTick,endTick:a,pitch:T.pitch,start:T.start,duration:u-T.start,velocity:T.velocity,beats:T.beats,track:T.track,finger:T.finger})}),new V({channels:s,keyRange:g,pedals:n,bars:l,endTime:u,endTick:a,correspondences:k,events:W,tempos:w,ticksPerBeat:A,meta:{},logger:r})}constructor(t){Object.assign(this,t),this.notes=[];for(const e of this.channels)if(e)for(const r of e)this.notes.push(r);this.notes.sort(function(e,r){return e.start-r.start});for(const e in this.notes)this.notes[e].index=Number(e);this.duration=this.notes.length>0?this.endTime-this.notes[0].start:0,this.pitchMap=[];for(const e in this.channels)for(const r in this.channels[e]){const o=this.channels[e][r].pitch;this.pitchMap[o]=this.pitchMap[o]||[],this.pitchMap[o].push(this.channels[e][r])}if(this.pitchMap.forEach(e=>e.sort((r,o)=>r.start-o.start)),this.meta.beatInfos)for(let e=0;e<this.meta.beatInfos.length;++e){const r=this.meta.beatInfos[e];if(e>0){const o=this.meta.beatInfos[e-1];r.beatIndex=o.beatIndex+Math.ceil((r.tick-o.tick)/this.ticksPerBeat)}else r.beatIndex=0}{let e=0,r=0,o=5e5;for(const c of this.tempos){const n=c.tick-r;e+=o/1e3*n/this.ticksPerBeat,r=c.tick,o=c.tempo,c.time=e}}}findChordBySoftindex(t,e=.8){return this.notes.filter(r=>Math.abs(r.softIndex-t)<e)}averageTempo(t=null){t=t||{from:0,to:this.endTick},this.logger&&this.logger.assert(!!this.tempos,"no tempos."),this.logger&&this.logger.assert(t.to>t.from,"range is invalid:",t);const e=r=>{const o=Math.max(t.from,this.tempos[r].tick),c=r<this.tempos.length-1?Math.min(this.tempos[r+1].tick,t.to):t.to;return Math.max(0,c-o)};return 6e7/(this.tempos.reduce((r,o,c)=>r+o.tempo*e(c),0)/(t.to-t.from))}ticksToTime(t){this.logger&&this.logger.assert(Number.isFinite(t),"invalid tick value:",t),this.logger&&this.logger.assert(!!this.tempos&&!!this.tempos.length,"no tempos.");const e=this.tempos.findIndex(c=>c.tick>t),r=e<0?this.tempos.length-1:Math.max(e-1,0),o=this.tempos[r];return o.time+(t-o.tick)*o.tempo*.001/this.ticksPerBeat}timeToTicks(t){this.logger&&this.logger.assert(Number.isFinite(t),"invalid time value:",t),this.logger&&this.logger.assert(!!this.tempos&&!!this.tempos.length,"no tempos.");const e=this.tempos.findIndex(c=>c.time>t),r=e<0?this.tempos.length-1:Math.max(e-1,0),o=this.tempos[r];return o.tick+(t-o.time)*this.ticksPerBeat/(o.tempo*.001)}tickRangeToTimeRange(t){return this.logger&&this.logger.assert(t.to>=t.from,"invalid tick range:",t),{from:this.ticksToTime(t.from),to:this.ticksToTime(t.to)}}scaleTempo({factor:t,headTempo:e}){this.logger&&this.logger.assert(!!this.tempos&&!!this.tempos.length,"[Notation.scaleTempo] tempos is empty."),e&&(t=e/this.tempos[0].tempo),this.logger&&this.logger.assert(Number.isFinite(t)&&t>0,"[Notation.scaleTempo] invalid factor:",t),this.tempos.forEach(r=>{r.tempo*=t,r.time*=t}),this.events.forEach(r=>{r.deltaTime*=t,r.time*=t}),this.notes.forEach(r=>{r.start*=t,r.duration*=t}),this.endTime*=t}}const dt=()=>new Promise(i=>requestAnimationFrame(i));class jt{constructor(t,{cacheSpan:e=600,onMidi:r,onPlayFinish:o,onTurnCursor:c}={}){this.cacheSpan=e,this.onMidi=r,this.onPlayFinish=o,this.onTurnCursor=c;let n;t.notes&&Number.isFinite(t.endTime)?n=t:n=V.parseMidi(t),this.notation=n,this.events=n.events,this.isPlaying=!1,this.progressTime=0,this.startTime=performance.now(),this.duration=n.endTime,this.cursorTurnDelta=0,console.assert(n.tempos&&n.tempos.length,"[MidiPlayer] invalid notation, tempos is empty.")}dispose(){this.isPlaying=!1,this.progressTime=0}get progressTicks(){return this.notation.timeToTicks(this.progressTime)}set progressTicks(t){this.progressTime=this.notation.ticksToTime(t),this.onTurnCursor&&this.onTurnCursor(this.progressTime)}async play({nextFrame:t=dt}={}){this.progressTime>=this.duration&&(this.progressTime=0);let e=performance.now();this.startTime=e-this.progressTime,this.isPlaying=!0;let r=this.events.findIndex(o=>o.time>=e-this.startTime);for(;this.isPlaying;){for(;r<this.events.length;++r){const o=this.events[r];if(!o||o.time>this.progressTime+this.cacheSpan)break;o.data.type==="channel"&&this.startTime+o.time>=e&&this.onMidi&&this.onMidi(o.data,this.startTime+o.time)}if(await t(),!this.isPlaying)break;if(this.cursorTurnDelta!==0){const o=this.cursorTurnDelta<0;if(this.startTime-=this.cursorTurnDelta,this.cursorTurnDelta=0,o)for(;r>0;--r){const c=this.events[r].time;if(this.startTime+c<e)break}}e=performance.now(),this.progressTime=e-this.startTime,this.progressTime>this.duration&&(this.isPlaying=!1,this.onPlayFinish&&this.onPlayFinish())}}pause(){this.isPlaying=!1}turnCursor(t){this.isPlaying?this.cursorTurnDelta+=t-this.progressTime:this.progressTime=t,this.onTurnCursor&&this.onTurnCursor(t)}}const mt={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",decodeArrayBuffer:function(i){const t=Math.ceil(3*i.length/4),e=new ArrayBuffer(t);return this.decode(i,e),e},decode:function(i,t){const e=this._keyStr.indexOf(i.charAt(i.length-1)),r=this._keyStr.indexOf(i.charAt(i.length-1));let o=Math.ceil(3*i.length/4);e===64&&o--,r===64&&o--;let c,n,s,l,u,h,d,y,f=0,g=0;for(t?c=new Uint8Array(t):c=new Uint8Array(o),i=i.replace(/[^A-Za-z0-9+/=]/g,""),f=0;f<o;f+=3)u=this._keyStr.indexOf(i.charAt(g++)),h=this._keyStr.indexOf(i.charAt(g++)),d=this._keyStr.indexOf(i.charAt(g++)),y=this._keyStr.indexOf(i.charAt(g++)),n=u<<2|h>>4,s=(h&15)<<4|d>>2,l=(d&3)<<6|y,c[f]=n,d!==64&&(c[f+1]=s),y!==64&&(c[f+2]=l);return c}},m=window.MIDI||{};window.MIDI=m;const Y=function(i){m.api=i.api,m.setVolume=i.setVolume,m.programChange=i.programChange,m.noteOn=i.noteOn,m.noteOff=i.noteOff,m.chordOn=i.chordOn,m.chordOff=i.chordOff,m.stopAllNotes=i.stopAllNotes,m.getInput=i.getInput,m.getOutputs=i.getOutputs};(function(){var i=null,t=null;const e=m.WebMIDI={api:"webmidi"};e.setVolume=function(r,o){t.send([176+r,7,o])},e.programChange=function(r,o){t.send([192+r,o])},e.noteOn=function(r,o,c,n){t.send([144+r,o,c],n*1e3)},e.noteOff=function(r,o,c){t.send([128+r,o,0],c*1e3)},e.chordOn=function(r,o,c,n){for(var s=0;s<o.length;s++){var l=o[s];t.send([144+r,l,c],n*1e3)}},e.chordOff=function(r,o,c){for(var n=0;n<o.length;n++){var s=o[n];t.send([128+r,s,0],c*1e3)}},e.stopAllNotes=function(){for(var r=0;r<16;r++)t.send([176+r,123,0])},e.getInput=function(){return i.getInputs()},e.getOutputs=function(){return i.getOutputs()},e.connect=function(r){Y(e),navigator.requestMIDIAccess().then(function(o){i=o,t=[...i.outputs][r.outputDeviceIndex||0][1],r.callback&&r.callback()},function(){window.AudioContext||window.webkitAudioContext?r.api="webaudio":window.Audio?r.api="audiotag":r.api="flash",m.loadPlugin(r)})}})();(window.AudioContext||window.webkitAudioContext)&&function(){if(window.MIDI&&window.MIDI.WebAudio){m.WebAudio=window.MIDI.WebAudio;return}const i=window.AudioContext||window.webkitAudioContext,t=m.WebAudio={api:"webaudio",pendingInstruments:{}};let e;const r={};let o=127;const c={},n=function(l,u,h,d,y){const f=m.GeneralMIDI.byName[l],g=f.number,p=u[h];if(!m.Soundfont[l][p])return y(l);const a=m.Soundfont[l][p].split(",")[1],k=mt.decodeArrayBuffer(a);e.decodeAudioData(k,function(w){let A=p;for(;A.length<3;)A+="&nbsp;";if(typeof m.loader<"u"&&m.loader.update(null,f.instrument+"<br>Processing: "+(h/87*100>>0)+"%<br>"+A),w.id=p,d[h]=w,d.length===u.length){for(;d.length;){if(w=d.pop(),!w)continue;const M=m.keyToNote[w.id];c[g+""+M]=w}y(l)}})},s=l=>Math.max((l-performance.now())*.001+e.currentTime,0);t.setVolume=function(l,u){o=u},t.empty=function(){return!Object.keys(c).length},t.hasPending=function(){return!Object.keys(t.pendingInstruments).length},t.programChange=function(l,u){m.channels[l].instrument=u},t.noteOn=function(l,u,h,d=0){if(!m.channels[l])return;const y=m.channels[l].instrument;if(!c[y+""+u])return;const f=s(d),g=e.createBufferSource();r[l+""+u]=g,g.buffer=c[y+""+u],g.connect(e.destination),e.createGain?g.gainNode=e.createGain():g.gainNode=e.createGainNode();const p=h/127*(o/127)*2-1;return g.gainNode.connect(e.destination),g.gainNode.gain.setTargetAtTime(Math.max(-1,p),e.currentTime,0),g.connect(g.gainNode),g.noteOn?g.noteOn(f):g.start(f),g},t.noteOff=function(l,u,h=0){const d=s(h),y=r[l+""+u];if(y){if(y.gainNode){const f=y.gainNode.gain;f.linearRampToValueAtTime(f.value,d),f.linearRampToValueAtTime(-1,d+.2)}y.noteOff?y.noteOff(d+.3):y.stop(d+.3),delete r[l+""+u]}},t.chordOn=function(l,u,h,d){for(var y={},f,g=0,p=u.length;g<p;g++)y[f=u[g]]=t.noteOn(l,f,h,d);return y},t.chordOff=function(l,u,h){for(var d={},y,f=0,g=u.length;f<g;f++)d[y=u[f]]=t.noteOff(l,y,h);return d},t.stopAllNotes=function(){for(var l in r){var u=0;u<e.currentTime&&(u+=e.currentTime),r[l].gainNode.gain.linearRampToValueAtTime(1,u),r[l].gainNode.gain.linearRampToValueAtTime(0,u+.2),delete r[l]}},t.connect=function(l){Y(t),e=new i;const u=[];for(const f in m.keyToNote)u.push(f);const h=[],d={},y=function(f){delete d[f];for(var g in d)break;!g&&l.callback&&l.callback()};for(const f in m.Soundfont){d[f]=!0;for(let g=0;g<u.length;g++)n(f,u,g,h,y)}}}();window.Audio&&function(){const i=m.AudioTag={api:"audiotag"};for(var t={},e=127,r=-1,o=[],c=[],n={},s=0;s<12;s++)o[s]=new Audio;var l=function(h,d){if(m.channels[h]){var y=m.channels[h].instrument,f=m.GeneralMIDI.byId[y].id,g=n[d];if(g){var p=f+""+g.id,a=(r+1)%o.length,k=o[a];c[a]=p,k.src=m.Soundfont[f][g.id],k.volume=e/127,k.play(),r=a}}},u=function(h,d){if(m.channels[h]){var y=m.channels[h].instrument,f=m.GeneralMIDI.byId[y].id,g=n[d];if(g)for(var p=f+""+g.id,a=0;a<o.length;a++){var k=(a+r+1)%o.length,w=c[k];if(w&&w===p){o[k].pause(),c[k]=null;return}}}};i.programChange=function(h,d){m.channels[h].instrument=d},i.setVolume=function(h,d){e=d},i.noteOn=function(h,d,y,f){var g=t[d];if(n[g]){if(f)return window.setTimeout(function(){l(h,g)},f*1e3);l(h,g)}},i.noteOff=function(h,d,y){var f=t[d];if(n[f]){if(y)return setTimeout(function(){u(h,f)},y*1e3);u(h,f)}},i.chordOn=function(h,d,y,f){for(var g=0;g<d.length;g++){var p=d[g],a=t[p];if(n[a]){if(f)return window.setTimeout(function(){l(h,a)},f*1e3);l(h,a)}}},i.chordOff=function(h,d,y){for(var f=0;f<d.length;f++){var g=d[f],p=t[g];if(n[p]){if(y)return window.setTimeout(function(){u(h,p)},y*1e3);u(h,p)}}},i.stopAllNotes=function(){for(var h=0,d=o.length;h<d;h++)o[h].pause()},i.connect=function(h){console.log("AudioTag.connect:",h);for(var d in m.keyToNote)t[m.keyToNote[d]]=d,n[d]={id:d};Y(i),h.callback&&h.callback()}}();m.GeneralMIDI=function(i){var t=function(u){return u.replace(/[^a-z0-9 ]/gi,"").replace(/[ ]/g,"_").toLowerCase()},e={byName:{},byId:{},byCategory:{}};for(var r in i)for(var o=i[r],c=0,n=o.length;c<n;c++){var s=o[c];if(s){var l=parseInt(s.substr(0,s.indexOf(" ")),10);s=s.replace(l+" ",""),e.byId[--l]=e.byName[t(s)]=e.byCategory[t(r)]={id:t(s),instrument:s,number:l,category:r}}}return e}({Piano:["1 Acoustic Grand Piano","2 Bright Acoustic Piano","3 Electric Grand Piano","4 Honky-tonk Piano","5 Electric Piano 1","6 Electric Piano 2","7 Harpsichord","8 Clavinet"],"Chromatic Percussion":["9 Celesta","10 Glockenspiel","11 Music Box","12 Vibraphone","13 Marimba","14 Xylophone","15 Tubular Bells","16 Dulcimer"],Organ:["17 Drawbar Organ","18 Percussive Organ","19 Rock Organ","20 Church Organ","21 Reed Organ","22 Accordion","23 Harmonica","24 Tango Accordion"],Guitar:["25 Acoustic Guitar (nylon)","26 Acoustic Guitar (steel)","27 Electric Guitar (jazz)","28 Electric Guitar (clean)","29 Electric Guitar (muted)","30 Overdriven Guitar","31 Distortion Guitar","32 Guitar Harmonics"],Bass:["33 Acoustic Bass","34 Electric Bass (finger)","35 Electric Bass (pick)","36 Fretless Bass","37 Slap Bass 1","38 Slap Bass 2","39 Synth Bass 1","40 Synth Bass 2"],Strings:["41 Violin","42 Viola","43 Cello","44 Contrabass","45 Tremolo Strings","46 Pizzicato Strings","47 Orchestral Harp","48 Timpani"],Ensemble:["49 String Ensemble 1","50 String Ensemble 2","51 Synth Strings 1","52 Synth Strings 2","53 Choir Aahs","54 Voice Oohs","55 Synth Choir","56 Orchestra Hit"],Brass:["57 Trumpet","58 Trombone","59 Tuba","60 Muted Trumpet","61 French Horn","62 Brass Section","63 Synth Brass 1","64 Synth Brass 2"],Reed:["65 Soprano Sax","66 Alto Sax","67 Tenor Sax","68 Baritone Sax","69 Oboe","70 English Horn","71 Bassoon","72 Clarinet"],Pipe:["73 Piccolo","74 Flute","75 Recorder","76 Pan Flute","77 Blown Bottle","78 Shakuhachi","79 Whistle","80 Ocarina"],"Synth Lead":["81 Lead 1 (square)","82 Lead 2 (sawtooth)","83 Lead 3 (calliope)","84 Lead 4 (chiff)","85 Lead 5 (charang)","86 Lead 6 (voice)","87 Lead 7 (fifths)","88 Lead 8 (bass + lead)"],"Synth Pad":["89 Pad 1 (new age)","90 Pad 2 (warm)","91 Pad 3 (polysynth)","92 Pad 4 (choir)","93 Pad 5 (bowed)","94 Pad 6 (metallic)","95 Pad 7 (halo)","96 Pad 8 (sweep)"],"Synth Effects":["97 FX 1 (rain)","98 FX 2 (soundtrack)","99 FX 3 (crystal)","100 FX 4 (atmosphere)","101 FX 5 (brightness)","102 FX 6 (goblins)","103 FX 7 (echoes)","104 FX 8 (sci-fi)"],Ethnic:["105 Sitar","106 Banjo","107 Shamisen","108 Koto","109 Kalimba","110 Bagpipe","111 Fiddle","112 Shanai"],Percussive:["113 Tinkle Bell","114 Agogo","115 Steel Drums","116 Woodblock","117 Taiko Drum","118 Melodic Tom","119 Synth Drum"],"Sound effects":["120 Reverse Cymbal","121 Guitar Fret Noise","122 Breath Noise","123 Seashore","124 Bird Tweet","125 Telephone Ring","126 Helicopter","127 Applause","128 Gunshot"]});m.channels=function(){for(var i={},t=0;t<16;t++)i[t]={instrument:0,mute:!1,mono:!1,omni:!1,solo:!1};return i}();m.pianoKeyOffset=21;m.keyToNote={};m.noteToKey={};(function(){for(var i=21,t=108,e=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],r=i;r<=t;r++){var o=(r-12)/12>>0,c=e[r%12]+o;m.keyToNote[c]=r,m.noteToKey[r]=c}})();const F={};let K=0;const Q=function(i){K++;const t=new Audio,e=i.split(";")[0];t.id="audio",t.setAttribute("preload","auto"),t.setAttribute("audiobuffer",!0),t.addEventListener("error",function(){F[e]=!1,K--},!1),t.addEventListener("canplaythrough",function(){F[e]=!0,K--},!1),t.src="data:"+i,document.body.appendChild(t)};function pt(i){if(typeof Audio>"u")return i({});const t=new Audio;if(typeof t.canPlayType>"u")return i(F);let e=t.canPlayType('audio/ogg; codecs="vorbis"');e=e==="probably"||e==="maybe";let r=t.canPlayType("audio/mpeg");if(r=r==="probably"||r==="maybe",!e&&!r){i(F);return}e&&Q("audio/ogg;base64,T2dnUwACAAAAAAAAAADqnjMlAAAAAOyyzPIBHgF2b3JiaXMAAAAAAUAfAABAHwAAQB8AAEAfAACZAU9nZ1MAAAAAAAAAAAAA6p4zJQEAAAANJGeqCj3//////////5ADdm9yYmlzLQAAAFhpcGguT3JnIGxpYlZvcmJpcyBJIDIwMTAxMTAxIChTY2hhdWZlbnVnZ2V0KQAAAAABBXZvcmJpcw9CQ1YBAAABAAxSFCElGVNKYwiVUlIpBR1jUFtHHWPUOUYhZBBTiEkZpXtPKpVYSsgRUlgpRR1TTFNJlVKWKUUdYxRTSCFT1jFloXMUS4ZJCSVsTa50FkvomWOWMUYdY85aSp1j1jFFHWNSUkmhcxg6ZiVkFDpGxehifDA6laJCKL7H3lLpLYWKW4q91xpT6y2EGEtpwQhhc+211dxKasUYY4wxxsXiUyiC0JBVAAABAABABAFCQ1YBAAoAAMJQDEVRgNCQVQBABgCAABRFcRTHcRxHkiTLAkJDVgEAQAAAAgAAKI7hKJIjSZJkWZZlWZameZaouaov+64u667t6roOhIasBACAAAAYRqF1TCqDEEPKQ4QUY9AzoxBDDEzGHGNONKQMMogzxZAyiFssLqgQBKEhKwKAKAAAwBjEGGIMOeekZFIi55iUTkoDnaPUUcoolRRLjBmlEluJMYLOUeooZZRCjKXFjFKJscRUAABAgAMAQICFUGjIigAgCgCAMAYphZRCjCnmFHOIMeUcgwwxxiBkzinoGJNOSuWck85JiRhjzjEHlXNOSuekctBJyaQTAAAQ4AAAEGAhFBqyIgCIEwAwSJKmWZomipamiaJniqrqiaKqWp5nmp5pqqpnmqpqqqrrmqrqypbnmaZnmqrqmaaqiqbquqaquq6nqrZsuqoum65q267s+rZru77uqapsm6or66bqyrrqyrbuurbtS56nqqKquq5nqq6ruq5uq65r25pqyq6purJtuq4tu7Js664s67pmqq5suqotm64s667s2rYqy7ovuq5uq7Ks+6os+75s67ru2rrwi65r66os674qy74x27bwy7ouHJMnqqqnqq7rmarrqq5r26rr2rqmmq5suq4tm6or26os67Yry7aumaosm64r26bryrIqy77vyrJui67r66Ys67oqy8Lu6roxzLat+6Lr6roqy7qvyrKuu7ru+7JuC7umqrpuyrKvm7Ks+7auC8us27oxuq7vq7It/KosC7+u+8Iy6z5jdF1fV21ZGFbZ9n3d95Vj1nVhWW1b+V1bZ7y+bgy7bvzKrQvLstq2scy6rSyvrxvDLux8W/iVmqratum6um7Ksq/Lui60dd1XRtf1fdW2fV+VZd+3hV9pG8OwjK6r+6os68Jry8ov67qw7MIvLKttK7+r68ow27qw3L6wLL/uC8uq277v6rrStXVluX2fsSu38QsAABhwAAAIMKEMFBqyIgCIEwBAEHIOKQahYgpCCKGkEEIqFWNSMuakZM5JKaWUFEpJrWJMSuaclMwxKaGUlkopqYRSWiqlxBRKaS2l1mJKqcVQSmulpNZKSa2llGJMrcUYMSYlc05K5pyUklJrJZXWMucoZQ5K6iCklEoqraTUYuacpA46Kx2E1EoqMZWUYgupxFZKaq2kFGMrMdXUWo4hpRhLSrGVlFptMdXWWqs1YkxK5pyUzDkqJaXWSiqtZc5J6iC01DkoqaTUYiopxco5SR2ElDLIqJSUWiupxBJSia20FGMpqcXUYq4pxRZDSS2WlFosqcTWYoy1tVRTJ6XFklKMJZUYW6y5ttZqDKXEVkqLsaSUW2sx1xZjjqGkFksrsZWUWmy15dhayzW1VGNKrdYWY40x5ZRrrT2n1mJNMdXaWqy51ZZbzLXnTkprpZQWS0oxttZijTHmHEppraQUWykpxtZara3FXEMpsZXSWiypxNhirLXFVmNqrcYWW62ltVprrb3GVlsurdXcYqw9tZRrrLXmWFNtBQAADDgAAASYUAYKDVkJAEQBAADGMMYYhEYpx5yT0ijlnHNSKucghJBS5hyEEFLKnINQSkuZcxBKSSmUklJqrYVSUmqttQIAAAocAAACbNCUWByg0JCVAEAqAIDBcTRNFFXVdX1fsSxRVFXXlW3jVyxNFFVVdm1b+DVRVFXXtW3bFn5NFFVVdmXZtoWiqrqybduybgvDqKqua9uybeuorqvbuq3bui9UXVmWbVu3dR3XtnXd9nVd+Bmzbeu2buu+8CMMR9/4IeTj+3RCCAAAT3AAACqwYXWEk6KxwEJDVgIAGQAAgDFKGYUYM0gxphhjTDHGmAAAgAEHAIAAE8pAoSErAoAoAADAOeecc84555xzzjnnnHPOOeecc44xxhhjjDHGGGOMMcYYY4wxxhhjjDHGGGOMMcYYY0wAwE6EA8BOhIVQaMhKACAcAABACCEpKaWUUkoRU85BSSmllFKqFIOMSkoppZRSpBR1lFJKKaWUIqWgpJJSSimllElJKaWUUkoppYw6SimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaVUSimllFJKKaWUUkoppRQAYPLgAACVYOMMK0lnhaPBhYasBAByAwAAhRiDEEJpraRUUkolVc5BKCWUlEpKKZWUUqqYgxBKKqmlklJKKbXSQSihlFBKKSWUUkooJYQQSgmhlFRCK6mEUkoHoYQSQimhhFRKKSWUzkEoIYUOQkmllNRCSB10VFIpIZVSSiklpZQ6CKGUklJLLZVSWkqpdBJSKamV1FJqqbWSUgmhpFZKSSWl0lpJJbUSSkklpZRSSymFVFJJJYSSUioltZZaSqm11lJIqZWUUkqppdRSSiWlkEpKqZSSUmollZRSaiGVlEpJKaTUSimlpFRCSamlUlpKLbWUSkmptFRSSaWUlEpJKaVSSksppRJKSqmllFpJKYWSUkoplZJSSyW1VEoKJaWUUkmptJRSSymVklIBAEAHDgAAAUZUWoidZlx5BI4oZJiAAgAAQABAgAkgMEBQMApBgDACAQAAAADAAAAfAABHARAR0ZzBAUKCwgJDg8MDAAAAAAAAAAAAAACAT2dnUwAEAAAAAAAAAADqnjMlAgAAADzQPmcBAQA="),r&&Q("audio/mpeg;base64,/+MYxAAAAANIAUAAAASEEB/jwOFM/0MM/90b/+RhST//w4NFwOjf///PZu////9lns5GFDv//l9GlUIEEIAAAgIg8Ir/JGq3/+MYxDsLIj5QMYcoAP0dv9HIjUcH//yYSg+CIbkGP//8w0bLVjUP///3Z0x5QCAv/yLjwtGKTEFNRTMuOTeqqqqqqqqqqqqq/+MYxEkNmdJkUYc4AKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq");const o=new Date().getTime(),c=window.setInterval(function(){const n=new Date().getTime()-o>5e3;(!K||n)&&(window.clearInterval(c),i(F))},1)}const z=function(){return this.loaded={},this.loading={},this};z.prototype.add=function(i){const t=this;typeof i=="string"&&(i={src:i});let e=i.srcs;typeof e>"u"&&(e=[{src:i.src,verify:i.verify}]);const r=document.getElementsByTagName("head")[0],o=function(l,u){t.loaded[l.src]||u&&typeof window[u]>"u"||(t.loaded[l.src]=!0,t.loading[l.src]&&t.loading[l.src](),delete t.loading[l.src],l.callback&&l.callback(),typeof getNext<"u"&&getNext())},c=[],n=function(l){if(typeof l=="string"&&(l={src:l,verify:i.verify}),/([\w\d.])$/.test(l.verify))if(l.test=l.verify,typeof l.test=="object")for(const h in l.test)c.push(l.test[h]);else c.push(l.test);if(t.loaded[l.src])return;const u=document.createElement("script");u.onreadystatechange=function(){this.readyState!=="loaded"&&this.readyState!=="complete"||o(l)},u.onload=function(){o(l)},u.onerror=function(){},u.setAttribute("type","text/javascript"),u.setAttribute("src",l.src),r.appendChild(u),t.loading[l.src]=function(){}},s=function(l){if(l)o(l,l.test);else for(let h=0;h<e.length;h++)o(e[h],e[h].test);let u=!0;for(let h=0;h<c.length;h++){let d=c[h];if(d&&d.indexOf(".")!==-1){d=d.split(".");const y=window[d[0]];if(typeof y>"u")continue;d.length===2?typeof y[d[1]]>"u"&&(u=!1):d.length===3&&typeof y[d[1]][d[2]]>"u"&&(u=!1)}else typeof window[d]>"u"&&(u=!1)}!i.strictOrder&&u?i.callback&&i.callback():setTimeout(function(){s(l)},10)};if(i.strictOrder){let l=-1;const u=function(){if(l++,!e[l])i.callback&&i.callback();else{const h=e[l],d=h.src;t.loading[d]?t.loading[d]=function(){h.callback&&h.callback(),u()}:t.loaded[d]?u():(n(h),s(h))}};u()}else{for(let l=0;l<e.length;l++)n(e[l]);s()}};const ft=new z;function gt(i){fetch(i.url,i.data).then(t=>t.text()).then(t=>{i.onload&&i.onload({responseText:t})}).catch(t=>{console.warn("DOMLoader.sendRequest error:",t),i.onerror&&i.onerror(t,!1)})}const G={script:ft,sendRequest:gt};m.Soundfont=window.MIDI&&window.MIDI.Soundfont||{};window.MIDI=m;m.audioDetect=pt;const C={};m.loadPlugin=function(i={}){typeof i=="function"&&(i={callback:i});var t=i.instruments||i.instrument||"acoustic_grand_piano";typeof t!="object"&&(t=[t]);for(var e=0;e<t.length;e++){var r=t[e];typeof r=="number"&&(t[e]=m.GeneralMIDI.byId[r])}if(m.soundfontUrl=i.soundfontUrl||m.soundfontUrl||"./soundfont/",m.audioDetect(function(o){var c="";if(yt[i.api]?c=i.api:window.webkitAudioContext||window.AudioContext?c="webaudio":window.Audio?c="audiotag":c="flash",!C[c])return;let n;i.targetFormat?n=i.targetFormat:n=o["audio/ogg"]?"ogg":"mp3",m.lang=c,m.supports=o,C[c](n,t,i)}),!i.callback)return new Promise(o=>i.callback=o)};C.webmidi=function(i,t,e){m.loader&&m.loader.message("Web MIDI API..."),m.WebMIDI.connect(e)};C.flash=function(i,t,e){m.loader&&m.loader.message("Flash API..."),G.script.add({src:e.soundManagerUrl||"./inc/SoundManager2/script/soundmanager2.js",verify:"SoundManager",callback:function(){m.Flash.connect(t,e)}})};C.audiotag=function(i,t,e){m.loader&&m.loader.message("HTML5 Audio API...");const r=tt({items:t,getNext(o){m.Soundfont[o]?r.getNext():G.sendRequest({url:m.soundfontUrl+o+"-"+i+".js",onprogress:_,onload(c){$(c.responseText),m.loader&&m.loader.update(null,"Downloading",100),r.getNext()}})},onComplete(){m.AudioTag.connect(e)}})};C.webaudio=function(i,t,e){m.loader&&m.loader.message("Web Audio API...");const r=tt({items:t,getNext(o){if(m.Soundfont[o]){r.getNext();return}m.WebAudio.pendingInstruments[t]=!0,G.sendRequest({url:m.soundfontUrl+o+"-"+i+".js",onprogress:_,onload(c){$(c.responseText),m.loader&&m.loader.update(null,"Downloading...",100),r.getNext(),delete m.WebAudio.pendingInstruments[t]},onerror(c){m.loader&&m.loader.update(c,"Download failed."),delete m.WebAudio.pendingInstruments[t]}})},onComplete(){m.WebAudio.connect(e)}})};const yt={webmidi:!0,webaudio:!0,audiotag:!0,flash:!0},$=function(i){var t=document.createElement("script");t.language="javascript",t.type="text/javascript",t.text=i,document.body.appendChild(t)},_=function(i){this.totalSize||(this.getResponseHeader("Content-Length-Raw")?this.totalSize=parseInt(this.getResponseHeader("Content-Length-Raw")):this.totalSize=i.total);const t=this.totalSize?Math.round(i.loaded/this.totalSize*100):"";m.loader&&m.loader.update(null,"Downloading...",t)},tt=function(i){const t={};t.queue=[];for(const e in i.items)i.items.hasOwnProperty(e)&&t.queue.push(i.items[e]);return t.getNext=function(){if(!t.queue.length)return i.onComplete();i.getNext(t.queue.shift())},setTimeout(t.getNext,1),t};m.loadPlugin;const et=(i,t)=>{const e=i.__vccOpts||i;for(const[r,o]of t)e[r]=o;return e},At={name:"svg-piano-roll",props:{notation:Object,notations:Object,timeScale:{type:Number,default:.001},pitchScale:{type:Number,default:1},focusNoteIndex:Number,tooltips:{type:Boolean,default:!1}},computed:{notationObj(){return this.notation?this.notation:this.notations?(console.warn("property of 'notations' deprecated, replace by 'notation'."),this.notations):(console.warn("property of 'notation' is required."),null)}},methods:{onClickNote(i){this.$emit("clickNote",i)}}},wt={class:"piano-roll-root mw-svg-piano-roll"},kt=["transform"],bt=["width","height","onClick"],Tt=["y2"],It={key:0};function St(i,t,e,r,o,c){return S(),q("g",wt,[(S(!0),q(U,null,O(c.notationObj.notes,(n,s)=>(S(),q("g",{key:s,class:"note",transform:`translate(${n.start*e.timeScale}, ${-n.pitch*e.pitchScale})`},[E("rect",{width:n.duration*e.timeScale,height:e.pitchScale,onClick:l=>c.onClickNote(n),class:st([{focus:n.index===e.focusNoteIndex,on:n.on},n.classes])},null,10,bt),E("line",{x1:0,x2:0,y1:0,y2:e.pitchScale},null,8,Tt),e.tooltips?(S(),q("title",It,`
				p: `+R(n.pitch)+`
				<tspan v-if="note.id">
					id: `+R(n.id)+`
				</tspan>
			`,1)):N("",!0)],8,kt))),128))])}const X=et(At,[["render",St]]),B={left:3,right:1},qt={name:"midi-roll",props:{midiURL:String,player:Object,height:{type:Number,default:200},width:Number,timeScale:{type:Number,default:.001}},components:{"svg-piano-roll":X},data(){return{notation:null,timeScroll:0,SvgPianoRoll:X}},computed:{widthLimited(){return Number.isFinite(this.width)},aspectRatio(){return this.widthLimited?this.width/this.height:1.6},viewHeight(){if(this.notation){const{low:i,high:t}=this.notation.keyRange;return t-i+5}return 90},justifyWidth(){return(this.notation?this.notation.endTime:this.height*this.aspectRatio)*this.timeScale+B.left+B.right},viewWidth(){return this.widthLimited?this.width*this.viewHeight/this.height:this.justifyWidth},viewBox(){return`-${B.left} ${this.notation?-this.notation.keyRange.high-1:0} ${this.viewWidth} ${this.viewHeight}`},pitchScales(){return this.notation?Array(9).fill().map((i,t)=>t*12).filter(i=>i>=this.notation.keyRange.low):[]},timeScales(){return this.notation?Array(Math.ceil(this.notation.endTime/15e3)).fill().map((i,t)=>t*15e3):[]},progressTime(){return this.player?this.player.progressTime:null},visibleTimeSpan(){return this.widthLimited?(this.viewWidth-(B.left+B.right))/this.timeScale:1/0},xScroll(){return this.timeScroll*this.timeScale}},created(){this.load()},methods:{async load(){if(this.notation=null,this.player)this.notation=this.player.notation,this.updateNoteStatus(),this.$forceUpdate();else if(this.midiURL){const i=await(await fetch(this.midiURL)).arrayBuffer(),t=H(i);this.notation=V.parseMidi(t)}},updateNoteStatus(){if(!this.notation)return;const i=Number.isFinite(this.progressTime);for(const t of this.notation.notes)t.on=i&&t.start<this.progressTime&&t.start+t.duration>this.progressTime},onClickCanvas(i){if(this.player){const t=(this.notation.keyRange.high-this.notation.keyRange.low+5)/this.height,e=(i.offsetX*t-B.left+this.xScroll)/this.timeScale;e>=0&&e<this.notation.endTime&&this.player.turnCursor(e)}},onMouseWheel(i){this.timeScroll+=i.deltaY*.4/this.timeScale},adjustTimeScroll(){this.progressTime-this.timeScroll>this.visibleTimeSpan*.6?this.timeScroll=Math.max(Math.min(this.progressTime-this.visibleTimeSpan*.6,this.notation.endTime-this.visibleTimeSpan),0):this.progressTime-this.timeScroll<this.visibleTimeSpan*.4&&(this.timeScroll=Math.max(this.progressTime-this.visibleTimeSpan*.4,0))}},watch:{midiURL:"load",player:"load",progressTime(){this.updateNoteStatus(),this.widthLimited&&this.adjustTimeScroll()}}},xt=["viewBox","height"],vt=["transform"],Et={key:0,class:"progress"},Mt=["height","width"],Bt=["x1","x2","y1"],Nt={key:1},Ct=["x1","x2","y1"],Ut=["x2","y1","y2"],Ot={key:0,class:"scales"},Ft=["height"],Kt=["y1"],Rt=["x2","y1","y2"],Vt=["y1","y2"],Wt=["y"],Dt=["transform"],Pt=["x1","x2","y1","y2"],Jt=["x","y"];function Zt(i,t,e,r,o,c){return S(),q("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:c.viewBox,height:e.height,class:"mw-midi-roll",onClick:t[0]||(t[0]=(...n)=>c.onClickCanvas&&c.onClickCanvas(...n)),onMousewheel:t[1]||(t[1]=(...n)=>c.onMouseWheel&&c.onMouseWheel(...n))},[E("g",{transform:`translate(${-c.xScroll}, 0)`},[c.progressTime&&o.notation?(S(),q("g",Et,[E("rect",{x:0,y:-120,height:121-o.notation.keyRange.low,width:c.progressTime*e.timeScale},null,8,Mt),E("line",{x1:c.progressTime*e.timeScale,x2:c.progressTime*e.timeScale,y1:-o.notation.keyRange.low+1,y2:"-120"},null,8,Bt)])):N("",!0),o.notation?(S(),q("g",Nt,[(S(!0),q(U,null,O(o.notation.bars,(n,s)=>(S(),q("g",{class:"bar measure",key:s},[n.index===0?(S(),q("line",{key:0,x1:n.time*e.timeScale,x2:n.time*e.timeScale,y1:-o.notation.keyRange.low+1,y2:"-120"},null,8,Ct)):N("",!0)]))),128)),(S(!0),q(U,null,O(c.pitchScales,n=>(S(),q("g",{class:"bar pitch-group",key:`p-${n}`},[E("line",{x1:0,x2:e.timeScale*o.notation.endTime,y1:-n+1,y2:-n+1},null,8,Ut)]))),128))])):N("",!0),o.notation?(S(),rt(ot(o.SvgPianoRoll),{key:2,notation:o.notation,timeScale:e.timeScale,pitchScale:1},null,8,["notation","timeScale"])):N("",!0)],8,vt),o.notation?(S(),q("g",Ot,[E("rect",{class:"pitch-padding",x:-10,y:-120,width:10,height:-o.notation.keyRange.low+121},null,8,Ft),E("line",{x1:"0",x2:"0",y1:-o.notation.keyRange.low+1,y2:"-120"},null,8,Kt),E("line",{x1:"0",x2:e.timeScale*o.notation.endTime-c.xScroll,y1:-o.notation.keyRange.low+1,y2:-o.notation.keyRange.low+1},null,8,Rt),(S(!0),q(U,null,O(c.pitchScales,n=>(S(),q("g",{class:"pitch-bar",key:`p-${n}`},[E("line",{x1:"-.8",x2:"0",y1:-n+.5,y2:-n+.5},null,8,Vt),E("text",{x:"-2",y:-n+1},R(n),9,Wt)]))),128)),E("g",{transform:`translate(${-c.xScroll}, 0)`},[(S(!0),q(U,null,O(c.timeScales,n=>(S(),q("g",{class:"time-bar",key:`t-${n}`},[E("line",{x1:n*e.timeScale,x2:n*e.timeScale,y1:-o.notation.keyRange.low+1,y2:-o.notation.keyRange.low+1.8},null,8,Pt),E("text",{x:n*e.timeScale,y:-o.notation.keyRange.low+4},R(n*.001)+"s",9,Jt)]))),128))],8,Dt)])):N("",!0)],40,xt)}const Lt=et(qt,[["render",Zt]]);export{jt as d,m as f,Lt as g,Gt as u};
