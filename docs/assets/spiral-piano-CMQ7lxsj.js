import{r as D}from"./vue-resize-directive-CDf_Yp3t.js";import{f as p,u as S,d as A}from"./musicWidgetsBrowser.es-ry_tjTyi.js";import"./utils-D-xC4oDh.js";import{_ as G,c,o as u,p as b,a as r,F as R,g as M,B as m,z as I,n as B,r as P,y as K,w as v,e as O,h as w,G as N,v as k,j as F,b as E,q as T}from"./router-JVv0ElFj.js";import{i as z}from"./loading-5d-DxwPLuS1.js";import{Q as H}from"./quit-cleaner-U9OkpSad.js";const W={name:"midi-devices",props:{value:String},mounted(){navigator.requestMIDIAccess&&(this.loading=!0,navigator.requestMIDIAccess().then(t=>{this.MidiAccess=t,this.refreshInputList()}))},beforeDestroyed(){if(this.MidiAccess){const t=this.MidiAccess.inputs.values();for(const e of t)e.onmidimessage=null}},data(){return{inputDevices:[],loading:!1}},computed:{navigatorSupported(){return navigator.requestMIDIAccess}},methods:{refreshInputList(){this.MidiAccess&&(this.loading=!0,this.inputDevices=[...this.MidiAccess.inputs.values()],this.$nextTick(()=>this.updateInputConnection()))},updateInputConnection(){if(this.$refs.inputList){const t=this.MidiAccess.inputs.values();for(const e of t)e.onmidimessage=e.id===this.$refs.inputList.value?o=>this.$emit("midiInput",o):null;this.$emit("input",this.$refs.inputList.value)}this.loading=!1}}},U={class:"midi-devices"},V={key:0},q=["disabled"],j=["value","selected"],Q={key:0},Z={key:1,class:"unsupported"};function J(t,e,o,l,n,i){return u(),c("div",U,[i.navigatorSupported?(u(),c("div",V,[r("select",{class:"input-list",title:"Choose a MIDI Input Device",ref:"inputList",onChange:e[0]||(e[0]=(...d)=>i.updateInputConnection&&i.updateInputConnection(...d)),disabled:n.loading||n.inputDevices.length==0},[(u(!0),c(R,null,M(n.inputDevices,d=>(u(),c("option",{key:d.id,value:d.id,selected:d.id===o.value},m(d.name),9,j))),128)),n.inputDevices.length==0?(u(),c("option",Q," No Connection ")):b("",!0)],40,q),r("button",{class:"refresh",onClick:e[1]||(e[1]=(...d)=>i.refreshInputList&&i.refreshInputList(...d))},"ðŸ”„")])):b("",!0),i.navigatorSupported?b("",!0):(u(),c("div",Z,[...e[2]||(e[2]=[I(" The browser does not supported ",-1),r("a",{href:"https://www.w3.org/TR/webmidi/",target:"_blank"},"WebMIDI APIs",-1),I(". ",-1)])]))])}const X=G(W,[["render",J],["__scopeId","data-v-2b51221f"]]),Y={name:"loading",data(){return{imgURL:z}}};function $(t,e,o,l,n,i){return u(),c("div",{style:B(`background-image: url(${n.imgURL})`),class:"loading"},null,4)}const ee=G(Y,[["render",$],["__scopeId","data-v-1410dc0f"]]),s={GroupLen:12,InnerRadius:30,ScrewPitch:4,KeyCount:88,NoteStart:21,NoteEnd:108,MiddleC:60,RegionRadius:400,Mode:{Major:{MainPitches:{0:!0,2:!0,4:!0,5:!0,7:!0,9:!0,11:!0},SyllableNames:["do",null,"re",null,"mi","fa",null,"so",null,"la",null,"ti"]},Minor:{MainPitches:{0:!0,2:!0,3:!0,5:!0,7:!0,8:!0,11:!0},SyllableNames:["do",null,"re","mi",null,"fa",null,"so","la",null,null,"ti"]}},KeySerials:{White:[0,2,4,5,7,9,11]},SpanKeyWidth:9},_=function(t){return s.NoteEnd-t},x=function(t){let e=t%s.GroupLen;return e<0&&(e+=s.GroupLen),e},te=function(t){return Math.floor(t/s.GroupLen)},ne=function(t){let e=t*7%12;for(;e<-5;)e+=12;for(;e>6;)e-=12;return e},ie=function(t,e){const o=[],l=(t+e)/2,n=(t-e)/2;for(let f=0;f<s.KeyCount+s.GroupLen+1;++f){const h=(_(f)-l)/n;o[f]=Math.exp(-h*h*h*h/2)}const i=o.reduce((f,h)=>f+h,0),d=(s.RegionRadius*.9-s.InnerRadius)*12/i;return o.map(f=>f*d)},se={name:"spiral-piano",directives:{resize:D},mixins:[H],components:{MidiDevices:X,Loading:ee},data(){return{Config:s,size:null,extends:null,keyRadius:Array(s.KeyCount+s.GroupLen+1).fill().map((t,e)=>s.InnerRadius+e*s.ScrewPitch/s.GroupLen),keyPoints:null,modalOffset:0,keyWidthRatio:.5,mode:s.Mode.Major,wideRange:{Start:54,End:77},synesthesiaScheme:"FifthRainbow",keyStatus:Array(s.NoteEnd+1).fill().map(()=>({active:!1})),showDashboard:!1,drageHover:!1,midiFileName:null,loading:!0,touchHolding:!1,player:null}},computed:{fullWidth(){return this.size&&this.size.height>this.size.width},regions(){return Array(s.GroupLen).fill().map((t,e)=>{const o=Math.PI*(1.5+e*2/s.GroupLen),l=Math.PI*(1.5+(e+this.getOffsetAngles(e))*2/s.GroupLen);return{angle:o,boderAngle:l,point:{x:Math.cos(l)*s.RegionRadius,y:Math.sin(l)*s.RegionRadius},nextIndex:e>0?e-1:s.GroupLen-1,main:x(e+this.modalOffset)in this.mode.MainPitches}})},keys(){return this.keyPoints?Array(s.KeyCount).fill().map((t,e)=>{const o=_(e),l=te(o),[n,i,d,f]=[e,e+1,e+s.GroupLen+1,e+s.GroupLen];return{pitch:o,group:l,step:x(o),path:`M${this.keyPoints[n].x},${this.keyPoints[n].y}
							A${this.keyRadius[n]},${this.keyRadius[n]} 0 0 0 ${this.keyPoints[i].x},${this.keyPoints[i].y}
							L${this.keyPoints[d].x},${this.keyPoints[d].y}
							A${this.keyRadius[f]},${this.keyRadius[f]} 0 0 1 ${this.keyPoints[f].x},${this.keyPoints[f].y}
							Z`.replace(/\n/g,"")}}):null},groups(){return this.keys?Array(9).fill().map((t,e)=>({index:e+1,keys:this.keys.filter(o=>o.group===e+1)})):null},wideRangeHash(){return`${this.wideRange.Start}|${this.wideRange.End}`},isPlaying(){return this.player&&this.player.isPlaying}},created(){p.WebAudio.empty()?p.loadPlugin({soundfontUrl:"./soundfont/",api:"webaudio"}).then(()=>{this.loading=!1,console.log("Soundfont loaded."),this.appendCleaner(()=>{p.stopAllNotes(),this.player&&this.player.dispose()})}):this.loading=!1},mounted(){this.updateKeyRadius(),window.addEventListener("keydown",t=>{switch(t.keyCode){case 120:this.showDashboard=!this.showDashboard;break}})},methods:{onResize(){this.size={width:this.$el.clientWidth,height:this.$el.clientHeight}},async loadFile(t){switch(t.type){case"audio/mid":case"audio/midi":this.player&&this.player.dispose(),this.loading=!0;const e=await t.readAs("ArrayBuffer"),o=S.parseMidiData(e);this.player=new A(o,{onMidi:(l,n)=>this.onMidi(l,n)}),console.log("MIDI file loaded."),this.midiFileName=t.name,this.onPlayFile(),this.loading=!1;break}},onMidi(t,e){if(!p.WebAudio.empty())switch(t.subtype){case"noteOn":this.activateKey(t.noteNumber,!0),p.noteOn(t.channel,t.noteNumber,t.velocity,e);break;case"noteOff":this.activateKey(t.noteNumber,!1),p.noteOff(t.channel,t.noteNumber,e);break;case"keySignature":this.modalOffset=ne(t.key);break}},onDropFiles(t){this.drageHover=!1,this.loadFile(t.dataTransfer.files[0])},onFileOpen(t){this.loadFile(t.target.files[0])},onPlayFile(){this.isPlaying?this.player.pause():this.player.play()},async onTouchStart(){this.touchHolding=!0;try{await new Promise((t,e)=>{this.interruptTouch=e,setTimeout(t,1600)}),this.$refs.filePicker.click(),this.touchHolding=!1,this.showDashboard=!0}catch{}},onTouchEnd(){this.touchHolding=!1,this.interruptTouch&&(this.interruptTouch(),this.interruptTouch=null)},updateKeyRadius(){this.extends=ie(this.wideRange.Start,this.wideRange.End);for(let t=0;t<s.KeyCount+s.GroupLen+1;++t){let e=0;for(let o=Math.floor(t/s.GroupLen);o>0;--o)e+=this.extends[t-o*s.GroupLen];this.keyRadius[t]=s.InnerRadius+t*s.ScrewPitch/s.GroupLen+e}this.keyPoints=Array(s.KeyCount+s.GroupLen+1).fill().map((t,e)=>{const o=this.getOffsetAngles(_(e)-this.modalOffset),l=Math.PI*(1.5-(this.modalOffset+e-o)*2/s.GroupLen),n=(this.keyRadius[e]+(e>0?this.keyRadius[e-1]:this.keyRadius[e]))/2;return{x:Math.cos(l)*n,y:Math.sin(l)*n}})},getOffsetAngles(t){const e=[x(t+1)in this.mode.MainPitches,x(t)in this.mode.MainPitches];return e[0]===e[1]?.5:e[0]?1-this.keyWidthRatio:this.keyWidthRatio},activateKey(t,e){this.keyStatus[t].active=e},onKeyDown(t){this.activateKey(t,!0),p.noteOn(0,t,100,0)},onKeyUp(t){this.activateKey(t,!1),p.noteOff(0,t,0)},onMidiInputMessage(t){const e=t.data[0]>>4,o=t.data[0]&15,l=t.data[1],n=t.data[2];switch(e){case 9:if(n>0){this.activateKey(l,!0),p.noteOn(o,l,n,0);break}case 8:this.activateKey(l,!1),p.noteOff(o,l,0);break}}},watch:{wideRangeHash:"updateKeyRadius"}},ae={class:"regions"},re=["d"],oe={class:"keys"},le={class:"labels"},ue=["x","y"],ce={class:"groups"},de=["data-index"],fe=["data-pitch","data-step","d","onMousedown","onMouseup","onTouchstart","onTouchend"],pe={class:"dashboard"},he=["max"],ye=["min"],ve={key:0},ge={class:"tips"};function me(t,e,o,l,n,i){const d=P("MidiDevices"),f=P("Loading"),h=K("resize");return v((u(),c("div",{class:w(["spiral-piano",{"drag-hover":n.drageHover,"touch-hover":n.touchHolding}]),onDragover:e[5]||(e[5]=F(a=>n.drageHover=!0,["prevent"])),onDragleave:e[6]||(e[6]=a=>n.drageHover=!1),onDrop:e[7]||(e[7]=F((...a)=>i.onDropFiles&&i.onDropFiles(...a),["prevent"])),onTouchstart:e[8]||(e[8]=(...a)=>i.onTouchStart&&i.onTouchStart(...a)),onTouchend:e[9]||(e[9]=(...a)=>i.onTouchEnd&&i.onTouchEnd(...a))},[(u(),c("svg",{class:w(["canvas",{"full-width":i.fullWidth,"full-height":!i.fullWidth}]),viewBox:"-500 -500 1000 1000"},[e[10]||(e[10]=N('<defs data-v-19c5ac48><filter id="filter-brilliancy" data-v-19c5ac48><feColorMatrix type="saturate" values="1.2" data-v-19c5ac48></feColorMatrix></filter><filter id="filter-middle-saturate" data-v-19c5ac48><feColorMatrix type="saturate" values="0.7" data-v-19c5ac48></feColorMatrix></filter><filter id="filter-grey" data-v-19c5ac48><feColorMatrix type="saturate" values="0.06" data-v-19c5ac48></feColorMatrix></filter><filter id="filter-brightness-n4" data-v-19c5ac48><feComponentTransfer data-v-19c5ac48><feFuncR type="linear" intercept="-0.4" slope="1" data-v-19c5ac48></feFuncR><feFuncG type="linear" intercept="-0.4" slope="1" data-v-19c5ac48></feFuncG><feFuncB type="linear" intercept="-0.4" slope="1" data-v-19c5ac48></feFuncB></feComponentTransfer></filter><filter id="filter-brightness-n3" data-v-19c5ac48><feComponentTransfer data-v-19c5ac48><feFuncR type="linear" intercept="-0.3" slope="1" data-v-19c5ac48></feFuncR><feFuncG type="linear" intercept="-0.3" slope="1" data-v-19c5ac48></feFuncG><feFuncB type="linear" intercept="-0.3" slope="1" data-v-19c5ac48></feFuncB></feComponentTransfer></filter><filter id="filter-brightness-n2" data-v-19c5ac48><feComponentTransfer data-v-19c5ac48><feFuncR type="linear" intercept="-0.2" slope="1" data-v-19c5ac48></feFuncR><feFuncG type="linear" intercept="-0.2" slope="1" data-v-19c5ac48></feFuncG><feFuncB type="linear" intercept="-0.2" slope="1" data-v-19c5ac48></feFuncB></feComponentTransfer></filter><filter id="filter-brightness-n1" data-v-19c5ac48><feComponentTransfer data-v-19c5ac48><feFuncR type="linear" intercept="-0.1" slope="1" data-v-19c5ac48></feFuncR><feFuncG type="linear" intercept="-0.1" slope="1" data-v-19c5ac48></feFuncG><feFuncB type="linear" intercept="-0.1" slope="1" data-v-19c5ac48></feFuncB></feComponentTransfer></filter><filter id="filter-brightness-1" data-v-19c5ac48><feComponentTransfer data-v-19c5ac48><feFuncR type="linear" intercept="0.1" slope="1" data-v-19c5ac48></feFuncR><feFuncG type="linear" intercept="0.1" slope="1" data-v-19c5ac48></feFuncG><feFuncB type="linear" intercept="0.1" slope="1" data-v-19c5ac48></feFuncB></feComponentTransfer></filter><filter id="filter-brightness-2" data-v-19c5ac48><feComponentTransfer data-v-19c5ac48><feFuncR type="linear" intercept="0.2" slope="1" data-v-19c5ac48></feFuncR><feFuncG type="linear" intercept="0.2" slope="1" data-v-19c5ac48></feFuncG><feFuncB type="linear" intercept="0.2" slope="1" data-v-19c5ac48></feFuncB></feComponentTransfer></filter><filter id="filter-brightness-3" data-v-19c5ac48><feComponentTransfer data-v-19c5ac48><feFuncR type="linear" intercept="0.3" slope="1" data-v-19c5ac48></feFuncR><feFuncG type="linear" intercept="0.3" slope="1" data-v-19c5ac48></feFuncG><feFuncB type="linear" intercept="0.3" slope="1" data-v-19c5ac48></feFuncB></feComponentTransfer></filter><filter id="filter-brightness-4" data-v-19c5ac48><feComponentTransfer data-v-19c5ac48><feFuncR type="linear" intercept="0.4" slope="1" data-v-19c5ac48></feFuncR><feFuncG type="linear" intercept="0.4" slope="1" data-v-19c5ac48></feFuncG><feFuncB type="linear" intercept="0.4" slope="1" data-v-19c5ac48></feFuncB></feComponentTransfer></filter><filter id="filter-brightness-5" data-v-19c5ac48><feComponentTransfer data-v-19c5ac48><feFuncR type="linear" intercept="0.5" slope="1" data-v-19c5ac48></feFuncR><feFuncG type="linear" intercept="0.5" slope="1" data-v-19c5ac48></feFuncG><feFuncB type="linear" intercept="0.5" slope="1" data-v-19c5ac48></feFuncB></feComponentTransfer></filter></defs>',1)),r("g",ae,[(u(!0),c(R,null,M(i.regions,(a,g)=>(u(),c("path",{key:g,class:w(["region",{main:a.main,deputy:!a.main}]),d:`M0,0 L${a.point.x},${a.point.y} A${n.Config.RegionRadius},${n.Config.RegionRadius} 0 0,0 ${i.regions[a.nextIndex].point.x},${i.regions[a.nextIndex].point.y} Z`},null,10,re))),128))]),e[11]||(e[11]=r("g",{class:"labels"},null,-1)),r("g",oe,[r("g",le,[(u(!0),c(R,null,M(n.mode.SyllableNames,(a,g)=>v((u(),c("text",{key:g,class:"syllable",x:Math.cos(i.regions[g].angle)*(n.Config.InnerRadius-8),y:Math.sin(i.regions[g].angle)*(n.Config.InnerRadius-8)+3},m(a),9,ue)),[[k,a!=null]])),128))]),r("g",ce,[(u(!0),c(R,null,M(i.groups,(a,g)=>(u(),c("g",{key:g,class:"group","data-index":a.index},[(u(!0),c(R,null,M(a.keys,(y,L)=>(u(),c("path",{key:L,class:w(["key",{active:n.keyStatus[y.pitch].active}]),"data-pitch":y.pitch,"data-step":y.step,d:y.path,onMousedown:F(C=>i.onKeyDown(y.pitch),["stop"]),onMouseup:C=>i.onKeyUp(y.pitch),onTouchstart:F(C=>i.onKeyDown(y.pitch),["stop","prevent"]),onTouchend:F(C=>i.onKeyUp(y.pitch),["prevent"])},null,42,fe))),128))],8,de))),128))])])],2)),v(r("div",pe,[r("table",null,[r("tbody",null,[r("tr",null,[e[12]||(e[12]=r("th",null,null,-1)),r("td",null,[E(d,{onMidiInput:i.onMidiInputMessage},null,8,["onMidiInput"])])]),r("tr",null,[e[13]||(e[13]=r("th",null,"Pitch Range",-1)),r("td",null,[v(r("input",{type:"range","onUpdate:modelValue":e[0]||(e[0]=a=>n.wideRange.Start=a),min:"21",max:n.wideRange.End-1},null,8,he),[[T,n.wideRange.Start,void 0,{number:!0}]]),v(r("input",{type:"range","onUpdate:modelValue":e[1]||(e[1]=a=>n.wideRange.End=a),min:n.wideRange.Start+1,max:"108"},null,8,ye),[[T,n.wideRange.End,void 0,{number:!0}]]),r("span",null,"["+m(n.wideRange.Start)+" - "+m(n.wideRange.End)+"]",1)])]),r("tr",null,[e[14]||(e[14]=r("th",null,"Modal",-1)),r("td",null,[v(r("input",{type:"range","onUpdate:modelValue":e[2]||(e[2]=a=>n.modalOffset=a),min:"-7",max:7},null,512),[[T,n.modalOffset,void 0,{number:!0}]]),I(" "+m(n.modalOffset),1)])]),n.midiFileName?(u(),c("tr",ve,[e[15]||(e[15]=r("th",null,null,-1)),r("td",null,[r("button",{onClick:e[3]||(e[3]=(...a)=>i.onPlayFile&&i.onPlayFile(...a))},m(i.isPlaying?"â¸":"â–¶"),1),r("span",null,m(n.midiFileName),1)])])):b("",!0)])]),v(r("input",{type:"file",ref:"filePicker",accept:"audio/midi",onChange:e[4]||(e[4]=(...a)=>i.onFileOpen&&i.onFileOpen(...a))},null,544),[[k,!1]])],512),[[k,n.showDashboard]]),v(r("div",ge," F9 show controls. ",512),[[k,i.isPlaying&&!n.showDashboard]]),n.loading?(u(),O(f,{key:0})):b("",!0)],34)),[[h,i.onResize]])}const xe=G(se,[["render",me],["__scopeId","data-v-19c5ac48"]]);export{xe as default};
