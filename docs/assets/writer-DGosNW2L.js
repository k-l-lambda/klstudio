import{u as g}from"./url-DHKDaZKd.js";import{l as b,Q as x,O as v,w as y}from"./tf-data.esm-IE7cwnvQ.js";import{_ as T,y as w,c as d,o as l,a as i,z as h,w as c,A as _,F as S,g as P,B as m,q as p,p as F}from"./router-JVv0ElFj.js";import"./_commonjsHelpers-DM6icglO.js";const k={mounted(t,e,n){var u;const a=Number((u=e.arg)==null?void 0:u.replace(/s$/,""))||0;let s=null;const r=e.value;t.__v_debounce__=function(...o){clearTimeout(s),s=setTimeout(()=>r.apply(n.ctx,o),a*1e3)}},beforeUnmount(t){t.__v_debounce__&&delete t.__v_debounce__}},f=()=>new Promise(t=>requestAnimationFrame(t)),N={name:"writer",data(){return{themes:[{name:"tang-poem",title:"唐诗"},{name:"threebody3",title:"三体III 死神永生"}],theme:g.parse(location.href).query,headText:null,bodyText:"",ready:!1,temperature:1,vocab:null,producing:!1,paused:!1}},computed:{markedHeadText(){return!this.vocab||!this.headText?this.headText:this.headText.split("").map(t=>Number.isInteger(this.vocab[t])?t:`<span class="invalid">${t}</span>`).join("")},sessionStatus:{get(){return{temperature:this.temperature}},set(t){Object.assign(this,t)}}},mounted(){this.loadStatus(),this.theme&&this.loadTheme()},beforeDestroy(){this.stopProducing()},methods:{loadStatus(){const t=sessionStorage.writerStatus&&JSON.parse(sessionStorage.writerStatus);t&&(this.sessionStatus=t)},saveStatus(){sessionStorage.writerStatus=JSON.stringify(this.sessionStatus)},async loadTheme(){this.chars=await(await fetch(`./mlmodels/char-rnn/${this.theme}/vocab.txt`)).text(),this.vocab=this.chars.split("").reduce((t,e,n)=>(t[e]=n,t),{}),this.ready=!0,console.log("vocab loaded:",this.theme)},onHeadText(){this.onRestart()},async onRestart(){this.ready&&(this.bodyText="",await this.stopProducing(),this.headText&&this.headText.length&&this.produce(this.headText))},async produce(t){console.log("producing..."),this.producing=!0,this.paused=!1;let e=t.split("").map(n=>this.vocab[n]).filter(Number.isInteger);if(!e.length){this.producing=!1;return}for(this.model=await b(`./mlmodels/char-rnn/${this.theme}/model.json`),console.log("model loaded.");!this.onProduceFinished;)for(e=x(()=>{const n=v([e]),a=this.model.predict(n).squeeze(),s=y(a.div(this.temperature),1);return(s.shape.length>1?s.slice([s.shape[0]-1,0],[1,1]).reshape([-1]):s.slice([s.shape[0]-1],[1])).dataSync()}),this.bodyText+=this.chars[e[0]],await f();this.paused&&!this.onProduceFinished;)await f();this.producing=!1,this.onProduceFinished&&this.onProduceFinished()},async stopProducing(){this.producing&&(await new Promise(t=>this.onProduceFinished=t),this.onProduceFinished=null,console.log("Producing stopped."))}},directives:{debounce:k},watch:{theme(){location.search=this.theme},temperature:"saveStatus"}},H=["value"],V=["disabled"],C=["title"],D={class:"output"},I=["innerHTML"],M=["textContent"];function O(t,e,n,a,s,r){const u=w("debounce");return l(),d("body",null,[i("section",null,[i("h2",null,[e[5]||(e[5]=h(" 主题： ",-1)),c(i("select",{"onUpdate:modelValue":e[0]||(e[0]=o=>s.theme=o)},[(l(!0),d(S,null,P(s.themes,o=>(l(),d("option",{key:o.name,value:o.name},m(o.title),9,H))),128))],512),[[_,s.theme]])])]),i("section",null,[c(i("textarea",{"onUpdate:modelValue":e[1]||(e[1]=o=>s.headText=o),disabled:!s.ready,placeholder:"在这里写个开头"},null,8,V),[[u,r.onHeadText,void 0,{"4s":!0}],[p,s.headText]])]),i("section",null,[e[6]||(e[6]=h(" 忠于原著 ",-1)),c(i("input",{type:"range",min:"0.01",max:"2",step:"any","onUpdate:modelValue":e[2]||(e[2]=o=>s.temperature=o),title:s.temperature.toFixed(2)},null,8,C),[[p,s.temperature,void 0,{number:!0}]]),e[7]||(e[7]=h(" 想象狂野 ",-1)),i("button",{onClick:e[3]||(e[3]=(...o)=>r.onRestart&&r.onRestart(...o))},"重写"),s.producing?(l(),d("button",{key:0,onClick:e[4]||(e[4]=o=>s.paused=!s.paused)},m(s.paused?"继续":"暂停"),1)):F("",!0)]),i("section",D,[i("span",{innerHTML:r.markedHeadText},null,8,I),i("pre",{ref:"output",textContent:m(s.bodyText)},null,8,M)])])}const U=T(N,[["render",O]]);export{U as default};
