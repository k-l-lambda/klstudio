<!DOCTYPE html>
<html>
	<head>
		<title>Clock</title>
		<style>
			html
			{
				font-family: Arial, Helvetica, sans-serif;
			}

			#canvas
			{
				display: block;
				position: absolute;
				top: 0;
				bottom: 0;
				left: 0;
				right: 0;
				margin: auto;
				width: 100vh;
				height: 100vh;
			}

			.frame
			{
				fill: none;
				stroke: #555;
			}

			.hour-scale
			{
				stroke: #555;
				stroke-width: 0.5;
			}

			.minute-scale
			{
				stroke: #555;
				stroke-width: 0.3;
			}

			.pointer-line
			{
				stroke: #000;
				stroke-width: 0.3;
			}

			#hour-pointer .pointer-line
			{
				stroke-width: 0.1;
			}

			.pointer-arrow
			{
				/*stroke: #ccc;
				stroke-width: 0.5;*/
				fill: #aaa;
				opacity: 0.3;
			}

			.pointer-hammer
			{
				fill: #faa;
				opacity: 0.8;
			}

			.scale-text
			{
				text-anchor: middle;
				font-size: 12px;
			}
		</style>
		<script src="../js/jquery.js" type="text/javascript"></script>
		<script src="../js/jquery.svg.js" type="text/javascript"></script>
		<script type="text/javascript">
			var svg = function (selector) {
				return new $.svg._wrapperClass($(selector)[0]);
			};

			var C = {
				CENTER_X: 200,
				CENTER_Y: 200,
				FRAME_RADIUS: 100,
				TEXT_POSITION: 0.87,
				HOUR_SCALE_LENGTH: 5,
				MINUTE_SCALE_LENGTH: 2
			};

			var StartTime = 0;
			var TimeScaler = 1;
			var TotalSpan = 3600000;
			var TextStart = 3600000;
			var TextInterval = 3600000;
			var TextFormat = "h";
			var TextSpan = 12;

			var TimerHandle = null;

			Date.prototype.format = function (format) {
				/*
				* eg:format="yyyy-MM-dd hh:mm:ss";
				*/
				var o = {
					"M+": this.getMonth() + 1,  //month
					"d+": this.getDate(),     //day
					"h+": this.getHours(),    //hour
					"m+": this.getMinutes(),  //minute
					"s+": this.getSeconds(), //second
					"q+": Math.floor((this.getMonth() + 3) / 3),  //quarter
					"S": this.getMilliseconds() //millisecond
				};

				if (/(y+)/.test(format)) {
					format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
				}

				for (var k in o) {
					if (new RegExp("(" + k + ")").test(format)) {
						format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
					}
				}
				return format;
			};

			Date.parseFormat = function (str, format) {
				var date = new Date();
				date.setTime(Date.parse(str.replace(format, "$1/$2/$3 $4:$5:$6 UTC")));

				return date;
			};

			var parseQueries = function (source) {
				var m = source.match(/^.*\?(.*)$|^([^\?]*)$/);
				var q = m[1] || m[2];

				var queries = q.match(/[^#\&\?]+/g);

				var dict = {};
				for (var i in queries) {
					var pair = queries[i].split("=");
					dict[pair[0]] = pair[1];
				}

				return dict;
			};

			var initializeClockFrame = function () {
				var canvas = svg("#canvas");
				canvas.configure({ viewBox: "80 80 240 240" });

				var panel = svg("#panel");
				panel.circle(C.CENTER_X, C.CENTER_Y, C.FRAME_RADIUS, { class: "frame" });

				// scales
				for (var i = 0; i < 12; ++i) {
					var angle = Math.PI * i / 6;
					var cosa = Math.cos(angle);
					var sina = Math.sin(angle);

					panel.line(C.CENTER_X + cosa * C.FRAME_RADIUS, C.CENTER_Y + sina * C.FRAME_RADIUS, C.CENTER_X + cosa * (C.FRAME_RADIUS - C.HOUR_SCALE_LENGTH), C.CENTER_Y + sina * (C.FRAME_RADIUS - C.HOUR_SCALE_LENGTH), { class: "hour-scale" });
				}

				for (var i = 0; i < 60; ++i) {
					if (i % 5) {
						var angle = Math.PI * i / 30;
						var cosa = Math.cos(angle);
						var sina = Math.sin(angle);

						panel.line(C.CENTER_X + cosa * C.FRAME_RADIUS, C.CENTER_Y + sina * C.FRAME_RADIUS, C.CENTER_X + cosa * (C.FRAME_RADIUS - C.MINUTE_SCALE_LENGTH), C.CENTER_Y + sina * (C.FRAME_RADIUS - C.MINUTE_SCALE_LENGTH), { class: "minute-scale" });
					}
				}

				// pointers
				var hourPointer = svg("#hour-pointer");
				var harrow = hourPointer.createPath();
				harrow.move(C.CENTER_X, C.CENTER_Y);
				harrow.line(C.CENTER_X - 5, C.CENTER_Y - C.FRAME_RADIUS * 0.14);
				harrow.line(C.CENTER_X, C.CENTER_Y - C.FRAME_RADIUS * 0.6);
				harrow.line(C.CENTER_X + 5, C.CENTER_Y - C.FRAME_RADIUS * 0.14);
				harrow.close();
				hourPointer.path(harrow, { class: "pointer-arrow" });
				hourPointer.line(C.CENTER_X, C.CENTER_Y - C.FRAME_RADIUS * 0.2, C.CENTER_X, C.CENTER_Y - C.FRAME_RADIUS * 0.9, { class: "pointer-line" });

				var minutePointer = svg("#minute-pointer");
				var marrow = minutePointer.createPath();
				marrow.move(C.CENTER_X, C.CENTER_Y);
				marrow.line(C.CENTER_X - 2, C.CENTER_Y - C.FRAME_RADIUS * 0.1);
				marrow.line(C.CENTER_X, C.CENTER_Y - C.FRAME_RADIUS * 0.95);
				marrow.line(C.CENTER_X + 2, C.CENTER_Y - C.FRAME_RADIUS * 0.1);
				marrow.close();
				minutePointer.path(marrow, { class: "pointer-arrow" });
				minutePointer.line(C.CENTER_X, C.CENTER_Y, C.CENTER_X, C.CENTER_Y - C.FRAME_RADIUS * 0.95, { class: "pointer-line" });

				var secondPointer = svg("#second-pointer");
				secondPointer.line(C.CENTER_X, C.CENTER_Y, C.CENTER_X, C.CENTER_Y - C.FRAME_RADIUS * 0.98, { class: "pointer-line" });
				secondPointer.circle(C.CENTER_X, C.CENTER_Y - C.FRAME_RADIUS * 0.93, 2, { class: "pointer-hammer" });

				// text
				if (TextInterval) {
					for (var t = TextStart; t <= TextSpan * 3600000 / TimeScaler; t += TextInterval) {
						var angle = Math.PI * 2 * t / (TextSpan * 3600000 / TimeScaler);
						var time = new Date(StartTime + t);

						panel.text(C.CENTER_X + Math.sin(angle) * C.FRAME_RADIUS * C.TEXT_POSITION, C.CENTER_Y - Math.cos(angle) * C.FRAME_RADIUS * C.TEXT_POSITION + 6, time.format(TextFormat), { class: "scale-text" });
					}
				}
			};

			var updatePointers = function (time) {
				var t = (time - StartTime) * TimeScaler;

				var ha = 360 * (t % 43200000) / 43200000;
				var ma = 360 * (t % 3600000) / 3600000;
				var sa = 360 * (t % 60000) / 60000;

				var hourPointer = svg("#hour-pointer");
				var minutePointer = svg("#minute-pointer");
				var secondPointer = svg("#second-pointer");

				var center = ", " + C.CENTER_X + ", " + C.CENTER_Y;

				hourPointer.configure({ transform: "rotate(" + ha + center + ")" });
				minutePointer.configure({ transform: "rotate(" + ma + center + ")" });
				secondPointer.configure({ transform: "rotate(" + sa + center + ")" });
			};

			$(function () {
				var params = parseQueries(location.hash);
				if (params.start)
					StartTime = Number(params.start);
				else
					StartTime = new Date().getTimezoneOffset() * 60000;

				if (params.span)
					TotalSpan = Number(params.span);

				if (params.end) {
					var end = Number(params.end);

					TimeScaler = TotalSpan / (end - StartTime);
				}

				if (params.texti)
					TextInterval = Number(params.texti);

				if (params.texts)
					TextStart = Number(params.texts);

				if (params.textf)
					TextFormat = params.textf;

				if (params.texth)
					TextSpan = Number(params.texth);

				var updateInterval = params.interval || 100;

				initializeClockFrame();

				TimerHandle = setInterval(function () {
					updatePointers(Date.now());
				}, updateInterval);
			});
		</script>
	</head>
	<body>
		<svg id="canvas">
			<g id="panel"></g>
			<g id="hour-pointer"></g>
			<g id="minute-pointer"></g>
			<g id="second-pointer"></g>
		</svg>
	</body>
</html>
